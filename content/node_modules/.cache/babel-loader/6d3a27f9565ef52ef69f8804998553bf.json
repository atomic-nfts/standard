{"ast":null,"code":"import { decodeAsn1, encodeAsn1 } from '../../util/asn1-encoder';\nimport { EncryptedPrivateKeyInfo, Pbes2Algorithms, Pbkdf2Params, Pbes2EsParams, Rc2CbcParameter } from '../../util/asn1-entities';\nimport { encryptWithPassword, decryptWithPassword } from '../../util/pbe';\nimport { uint8ArrayToInteger, hexStringToUint8Array } from '../../util/binary';\nimport { UnsupportedAlgorithmError, DecodeAsn1FailedError, MissingPasswordError } from '../../util/errors';\nimport { validateEncryptionAlgorithm } from '../../util/validator';\nimport { OIDS, FLIPPED_OIDS } from '../../util/oids';\nexport var decryptWithPBES2 = function decryptWithPBES2(encryptedData, encryptionAlgorithmParamsAsn1, password) {\n  var _decodeAsn = decodeAsn1(encryptionAlgorithmParamsAsn1, Pbes2Algorithms),\n      keyDerivationFunc = _decodeAsn.keyDerivationFunc,\n      encryptionScheme = _decodeAsn.encryptionScheme;\n\n  var keyDerivationFuncId = OIDS[keyDerivationFunc.id];\n  var encryptionSchemeId = OIDS[encryptionScheme.id];\n  var effectiveKeyDerivationFunc = {\n    id: keyDerivationFuncId\n  };\n  var effectiveEncryptionScheme = {\n    id: encryptionSchemeId\n  }; // Process encryption scheme\n\n  switch (encryptionSchemeId) {\n    case 'aes128-cbc':\n    case 'aes192-cbc':\n    case 'aes256-cbc':\n    case 'des-ede3-cbc':\n    case 'des-cbc':\n      effectiveEncryptionScheme.iv = decodeAsn1(encryptionScheme.parameters, Pbes2EsParams[encryptionSchemeId]);\n      break;\n\n    case 'rc2-cbc':\n      {\n        var rc2CBCParameter = decodeAsn1(encryptionScheme.parameters, Rc2CbcParameter);\n        var rc2ParameterVersion = uint8ArrayToInteger(rc2CBCParameter.rc2ParameterVersion);\n        effectiveEncryptionScheme.iv = rc2CBCParameter.iv; // RC2-CBCParameter encoding of the \"effective key bits\" as defined in:\n        // https://tools.ietf.org/html/rfc2898#appendix-B.2.3\n\n        switch (rc2ParameterVersion) {\n          case 160:\n            effectiveEncryptionScheme.bits = 40;\n            break;\n\n          case 120:\n            effectiveEncryptionScheme.bits = 64;\n            break;\n\n          case 58:\n            effectiveEncryptionScheme.bits = 128;\n            break;\n\n          default:\n            throw new UnsupportedAlgorithmError(\"Unsupported RC2 version parameter with value '\".concat(rc2ParameterVersion, \"'\"));\n        }\n\n        break;\n      }\n\n    default:\n      throw new UnsupportedAlgorithmError(\"Unsupported encryption scheme algorithm OID '\".concat(encryptionScheme.id, \"'\"));\n  } // Process key derivation func\n\n\n  switch (keyDerivationFuncId) {\n    case 'pbkdf2':\n      {\n        var pbkdf2Params = decodeAsn1(keyDerivationFunc.parameters, Pbkdf2Params);\n        var prfId = OIDS[pbkdf2Params.prf.id];\n        /* istanbul ignore if */\n\n        if (pbkdf2Params.salt.type !== 'specified') {\n          throw new UnsupportedAlgorithmError('Only \\'specified\\' salts are supported in PBKDF2');\n        }\n\n        if (!prfId) {\n          throw new UnsupportedAlgorithmError(\"Unsupported prf algorithm OID '\".concat(pbkdf2Params.prf.id, \"'\"));\n        }\n\n        effectiveKeyDerivationFunc.salt = pbkdf2Params.salt.value;\n        effectiveKeyDerivationFunc.iterationCount = uint8ArrayToInteger(pbkdf2Params.iterationCount);\n        effectiveKeyDerivationFunc.prf = prfId;\n\n        if (pbkdf2Params.keyLength) {\n          effectiveKeyDerivationFunc.keyLength = uint8ArrayToInteger(pbkdf2Params.keyLength);\n        }\n\n        break;\n      }\n\n    default:\n      throw new UnsupportedAlgorithmError(\"Unsupported key derivation function algorithm OID '\".concat(keyDerivationFunc.id, \"'\"));\n  }\n\n  var encryptionAlgorithm = {\n    keyDerivationFunc: effectiveKeyDerivationFunc,\n    encryptionScheme: effectiveEncryptionScheme\n  };\n  var decryptedData = decryptWithPassword(encryptedData, encryptionAlgorithm, password);\n  return {\n    encryptionAlgorithm: encryptionAlgorithm,\n    decryptedData: decryptedData\n  };\n};\nexport var encryptWithPBES2 = function encryptWithPBES2(data, encryptionAlgorithm, password) {\n  encryptionAlgorithm = validateEncryptionAlgorithm(encryptionAlgorithm, 'pbkdf2', 'aes256-cbc');\n  var _encryptionAlgorithm = encryptionAlgorithm,\n      keyDerivationFunc = _encryptionAlgorithm.keyDerivationFunc,\n      encryptionScheme = _encryptionAlgorithm.encryptionScheme;\n  var encodeEncryptionSchemeAsn1ParamsFn;\n  var encodeKeyDerivationFuncAsn1ParamsFn; // Process encryption scheme\n\n  switch (encryptionScheme.id) {\n    case 'aes128-cbc':\n    case 'aes192-cbc':\n    case 'aes256-cbc':\n    case 'des-ede3-cbc':\n    case 'des-cbc':\n      encodeEncryptionSchemeAsn1ParamsFn = function encodeEncryptionSchemeAsn1ParamsFn(_ref) {\n        var iv = _ref.iv;\n        return encodeAsn1(iv, Pbes2EsParams[encryptionScheme.id]);\n      };\n\n      break;\n\n    case 'rc2-cbc':\n      encodeEncryptionSchemeAsn1ParamsFn = function encodeEncryptionSchemeAsn1ParamsFn(_ref2) {\n        var iv = _ref2.iv,\n            bits = _ref2.bits;\n        var rc2ParameterVersion; // RC2-CBCParameter encoding of the \"effective key bits\" as defined in:\n        // https://tools.ietf.org/html/rfc2898#appendix-B.2.3\n\n        switch (bits) {\n          case 40:\n            rc2ParameterVersion = 160;\n            break;\n\n          case 64:\n            rc2ParameterVersion = 120;\n            break;\n\n          case 128:\n            rc2ParameterVersion = 58;\n            break;\n\n          default:\n            throw new UnsupportedAlgorithmError(\"Unsupported RC2 bits parameter with value '\".concat(rc2ParameterVersion, \"'\"));\n        }\n\n        return encodeAsn1({\n          iv: iv,\n          rc2ParameterVersion: rc2ParameterVersion\n        }, Rc2CbcParameter);\n      };\n\n      break;\n\n    default:\n      throw new UnsupportedAlgorithmError(\"Unsupported encryption scheme id '\".concat(encryptionScheme.id, \"'\"));\n  } // Process key derivation name\n\n\n  switch (keyDerivationFunc.id) {\n    case 'pbkdf2':\n      encodeKeyDerivationFuncAsn1ParamsFn = function encodeKeyDerivationFuncAsn1ParamsFn(_ref3) {\n        var salt = _ref3.salt,\n            iterationCount = _ref3.iterationCount,\n            prf = _ref3.prf;\n        return encodeAsn1({\n          salt: {\n            type: 'specified',\n            value: salt\n          },\n          iterationCount: iterationCount,\n          keyLength: keyDerivationFunc.keyLength,\n          prf: {\n            id: FLIPPED_OIDS[prf],\n            parameters: hexStringToUint8Array('0500')\n          }\n        }, Pbkdf2Params);\n      };\n\n      break;\n\n    default:\n      throw new UnsupportedAlgorithmError(\"Unsupported key derivation function id '\".concat(keyDerivationFunc.id, \"'\"));\n  }\n\n  var _encryptWithPassword = encryptWithPassword(data, encryptionAlgorithm, password),\n      encryptedData = _encryptWithPassword.encryptedData,\n      effectiveEncryptionAlgorithm = _encryptWithPassword.effectiveEncryptionAlgorithm;\n\n  var encryptionAlgorithmParamsAsn1 = encodeAsn1({\n    keyDerivationFunc: {\n      id: FLIPPED_OIDS[keyDerivationFunc.id],\n      parameters: encodeKeyDerivationFuncAsn1ParamsFn(effectiveEncryptionAlgorithm.keyDerivationFunc)\n    },\n    encryptionScheme: {\n      id: FLIPPED_OIDS[encryptionScheme.id],\n      parameters: encodeEncryptionSchemeAsn1ParamsFn(effectiveEncryptionAlgorithm.encryptionScheme)\n    }\n  }, Pbes2Algorithms);\n  return {\n    encryptionAlgorithmParamsAsn1: encryptionAlgorithmParamsAsn1,\n    encryptedData: encryptedData\n  };\n};\nexport var maybeDecryptPrivateKeyInfo = function maybeDecryptPrivateKeyInfo(encryptedPrivateKeyInfoAsn1, password) {\n  var encryptedPrivateKeyInfo;\n\n  try {\n    encryptedPrivateKeyInfo = decodeAsn1(encryptedPrivateKeyInfoAsn1, EncryptedPrivateKeyInfo);\n  } catch (err) {\n    /* istanbul ignore else */\n    if (err instanceof DecodeAsn1FailedError) {\n      return {\n        encryptionAlgorithm: null,\n        privateKeyInfoAsn1: encryptedPrivateKeyInfoAsn1\n      };\n    }\n    /* istanbul ignore next */\n\n\n    throw err;\n  }\n\n  if (!password) {\n    throw new MissingPasswordError('Please specify the password to decrypt the key');\n  }\n\n  var _encryptedPrivateKeyI = encryptedPrivateKeyInfo,\n      encryptionAlgorithm = _encryptedPrivateKeyI.encryptionAlgorithm,\n      encryptedData = _encryptedPrivateKeyI.encryptedData;\n  var encryptionAlgorithmId = OIDS[encryptionAlgorithm.id];\n  var encryptionAlgorithmParamsAsn1 = encryptionAlgorithm.parameters;\n  var decryptionResult;\n\n  switch (encryptionAlgorithmId) {\n    case 'pbes2':\n      decryptionResult = decryptWithPBES2(encryptedData, encryptionAlgorithmParamsAsn1, password);\n      break;\n\n    default:\n      throw new UnsupportedAlgorithmError(\"Unsupported encryption algorithm OID '\".concat(encryptionAlgorithm.id, \"'\"));\n  }\n\n  return {\n    encryptionAlgorithm: decryptionResult.encryptionAlgorithm,\n    privateKeyInfoAsn1: decryptionResult.decryptedData\n  };\n};\nexport var maybeEncryptPrivateKeyInfo = function maybeEncryptPrivateKeyInfo(privateKeyInfoAsn1, encryptionAlgorithm, password) {\n  if (!password && !encryptionAlgorithm) {\n    return privateKeyInfoAsn1;\n  }\n\n  if (!password && encryptionAlgorithm) {\n    throw new MissingPasswordError('An encryption algorithm was specified but no password was set');\n  }\n\n  var _encryptWithPBES = encryptWithPBES2(privateKeyInfoAsn1, encryptionAlgorithm, password),\n      encryptedData = _encryptWithPBES.encryptedData,\n      encryptionAlgorithmParamsAsn1 = _encryptWithPBES.encryptionAlgorithmParamsAsn1;\n\n  var encryptedPrivateKeyInfoAsn1 = encodeAsn1({\n    encryptionAlgorithm: {\n      id: FLIPPED_OIDS.pbes2,\n      parameters: encryptionAlgorithmParamsAsn1\n    },\n    encryptedData: encryptedData\n  }, EncryptedPrivateKeyInfo);\n  return encryptedPrivateKeyInfoAsn1;\n};","map":{"version":3,"sources":["/home/al/Desktop/koi/narcissus/content/node_modules/crypto-key-composer/es/formats/pkcs8/encryption.js"],"names":["decodeAsn1","encodeAsn1","EncryptedPrivateKeyInfo","Pbes2Algorithms","Pbkdf2Params","Pbes2EsParams","Rc2CbcParameter","encryptWithPassword","decryptWithPassword","uint8ArrayToInteger","hexStringToUint8Array","UnsupportedAlgorithmError","DecodeAsn1FailedError","MissingPasswordError","validateEncryptionAlgorithm","OIDS","FLIPPED_OIDS","decryptWithPBES2","encryptedData","encryptionAlgorithmParamsAsn1","password","keyDerivationFunc","encryptionScheme","keyDerivationFuncId","id","encryptionSchemeId","effectiveKeyDerivationFunc","effectiveEncryptionScheme","iv","parameters","rc2CBCParameter","rc2ParameterVersion","bits","pbkdf2Params","prfId","prf","salt","type","value","iterationCount","keyLength","encryptionAlgorithm","decryptedData","encryptWithPBES2","data","encodeEncryptionSchemeAsn1ParamsFn","encodeKeyDerivationFuncAsn1ParamsFn","effectiveEncryptionAlgorithm","maybeDecryptPrivateKeyInfo","encryptedPrivateKeyInfoAsn1","encryptedPrivateKeyInfo","err","privateKeyInfoAsn1","encryptionAlgorithmId","decryptionResult","maybeEncryptPrivateKeyInfo","pbes2"],"mappings":"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","sourcesContent":["import { decodeAsn1, encodeAsn1 } from '../../util/asn1-encoder';\nimport { EncryptedPrivateKeyInfo, Pbes2Algorithms, Pbkdf2Params, Pbes2EsParams, Rc2CbcParameter } from '../../util/asn1-entities';\nimport { encryptWithPassword, decryptWithPassword } from '../../util/pbe';\nimport { uint8ArrayToInteger, hexStringToUint8Array } from '../../util/binary';\nimport { UnsupportedAlgorithmError, DecodeAsn1FailedError, MissingPasswordError } from '../../util/errors';\nimport { validateEncryptionAlgorithm } from '../../util/validator';\nimport { OIDS, FLIPPED_OIDS } from '../../util/oids';\nexport const decryptWithPBES2 = (encryptedData, encryptionAlgorithmParamsAsn1, password) => {\n  const {\n    keyDerivationFunc,\n    encryptionScheme\n  } = decodeAsn1(encryptionAlgorithmParamsAsn1, Pbes2Algorithms);\n  const keyDerivationFuncId = OIDS[keyDerivationFunc.id];\n  const encryptionSchemeId = OIDS[encryptionScheme.id];\n  const effectiveKeyDerivationFunc = {\n    id: keyDerivationFuncId\n  };\n  const effectiveEncryptionScheme = {\n    id: encryptionSchemeId\n  }; // Process encryption scheme\n\n  switch (encryptionSchemeId) {\n    case 'aes128-cbc':\n    case 'aes192-cbc':\n    case 'aes256-cbc':\n    case 'des-ede3-cbc':\n    case 'des-cbc':\n      effectiveEncryptionScheme.iv = decodeAsn1(encryptionScheme.parameters, Pbes2EsParams[encryptionSchemeId]);\n      break;\n\n    case 'rc2-cbc':\n      {\n        const rc2CBCParameter = decodeAsn1(encryptionScheme.parameters, Rc2CbcParameter);\n        const rc2ParameterVersion = uint8ArrayToInteger(rc2CBCParameter.rc2ParameterVersion);\n        effectiveEncryptionScheme.iv = rc2CBCParameter.iv; // RC2-CBCParameter encoding of the \"effective key bits\" as defined in:\n        // https://tools.ietf.org/html/rfc2898#appendix-B.2.3\n\n        switch (rc2ParameterVersion) {\n          case 160:\n            effectiveEncryptionScheme.bits = 40;\n            break;\n\n          case 120:\n            effectiveEncryptionScheme.bits = 64;\n            break;\n\n          case 58:\n            effectiveEncryptionScheme.bits = 128;\n            break;\n\n          default:\n            throw new UnsupportedAlgorithmError(`Unsupported RC2 version parameter with value '${rc2ParameterVersion}'`);\n        }\n\n        break;\n      }\n\n    default:\n      throw new UnsupportedAlgorithmError(`Unsupported encryption scheme algorithm OID '${encryptionScheme.id}'`);\n  } // Process key derivation func\n\n\n  switch (keyDerivationFuncId) {\n    case 'pbkdf2':\n      {\n        const pbkdf2Params = decodeAsn1(keyDerivationFunc.parameters, Pbkdf2Params);\n        const prfId = OIDS[pbkdf2Params.prf.id];\n        /* istanbul ignore if */\n\n        if (pbkdf2Params.salt.type !== 'specified') {\n          throw new UnsupportedAlgorithmError('Only \\'specified\\' salts are supported in PBKDF2');\n        }\n\n        if (!prfId) {\n          throw new UnsupportedAlgorithmError(`Unsupported prf algorithm OID '${pbkdf2Params.prf.id}'`);\n        }\n\n        effectiveKeyDerivationFunc.salt = pbkdf2Params.salt.value;\n        effectiveKeyDerivationFunc.iterationCount = uint8ArrayToInteger(pbkdf2Params.iterationCount);\n        effectiveKeyDerivationFunc.prf = prfId;\n\n        if (pbkdf2Params.keyLength) {\n          effectiveKeyDerivationFunc.keyLength = uint8ArrayToInteger(pbkdf2Params.keyLength);\n        }\n\n        break;\n      }\n\n    default:\n      throw new UnsupportedAlgorithmError(`Unsupported key derivation function algorithm OID '${keyDerivationFunc.id}'`);\n  }\n\n  const encryptionAlgorithm = {\n    keyDerivationFunc: effectiveKeyDerivationFunc,\n    encryptionScheme: effectiveEncryptionScheme\n  };\n  const decryptedData = decryptWithPassword(encryptedData, encryptionAlgorithm, password);\n  return {\n    encryptionAlgorithm,\n    decryptedData\n  };\n};\nexport const encryptWithPBES2 = (data, encryptionAlgorithm, password) => {\n  encryptionAlgorithm = validateEncryptionAlgorithm(encryptionAlgorithm, 'pbkdf2', 'aes256-cbc');\n  const {\n    keyDerivationFunc,\n    encryptionScheme\n  } = encryptionAlgorithm;\n  let encodeEncryptionSchemeAsn1ParamsFn;\n  let encodeKeyDerivationFuncAsn1ParamsFn; // Process encryption scheme\n\n  switch (encryptionScheme.id) {\n    case 'aes128-cbc':\n    case 'aes192-cbc':\n    case 'aes256-cbc':\n    case 'des-ede3-cbc':\n    case 'des-cbc':\n      encodeEncryptionSchemeAsn1ParamsFn = ({\n        iv\n      }) => encodeAsn1(iv, Pbes2EsParams[encryptionScheme.id]);\n\n      break;\n\n    case 'rc2-cbc':\n      encodeEncryptionSchemeAsn1ParamsFn = ({\n        iv,\n        bits\n      }) => {\n        let rc2ParameterVersion; // RC2-CBCParameter encoding of the \"effective key bits\" as defined in:\n        // https://tools.ietf.org/html/rfc2898#appendix-B.2.3\n\n        switch (bits) {\n          case 40:\n            rc2ParameterVersion = 160;\n            break;\n\n          case 64:\n            rc2ParameterVersion = 120;\n            break;\n\n          case 128:\n            rc2ParameterVersion = 58;\n            break;\n\n          default:\n            throw new UnsupportedAlgorithmError(`Unsupported RC2 bits parameter with value '${rc2ParameterVersion}'`);\n        }\n\n        return encodeAsn1({\n          iv,\n          rc2ParameterVersion\n        }, Rc2CbcParameter);\n      };\n\n      break;\n\n    default:\n      throw new UnsupportedAlgorithmError(`Unsupported encryption scheme id '${encryptionScheme.id}'`);\n  } // Process key derivation name\n\n\n  switch (keyDerivationFunc.id) {\n    case 'pbkdf2':\n      encodeKeyDerivationFuncAsn1ParamsFn = ({\n        salt,\n        iterationCount,\n        prf\n      }) => encodeAsn1({\n        salt: {\n          type: 'specified',\n          value: salt\n        },\n        iterationCount,\n        keyLength: keyDerivationFunc.keyLength,\n        prf: {\n          id: FLIPPED_OIDS[prf],\n          parameters: hexStringToUint8Array('0500')\n        }\n      }, Pbkdf2Params);\n\n      break;\n\n    default:\n      throw new UnsupportedAlgorithmError(`Unsupported key derivation function id '${keyDerivationFunc.id}'`);\n  }\n\n  const {\n    encryptedData,\n    effectiveEncryptionAlgorithm\n  } = encryptWithPassword(data, encryptionAlgorithm, password);\n  const encryptionAlgorithmParamsAsn1 = encodeAsn1({\n    keyDerivationFunc: {\n      id: FLIPPED_OIDS[keyDerivationFunc.id],\n      parameters: encodeKeyDerivationFuncAsn1ParamsFn(effectiveEncryptionAlgorithm.keyDerivationFunc)\n    },\n    encryptionScheme: {\n      id: FLIPPED_OIDS[encryptionScheme.id],\n      parameters: encodeEncryptionSchemeAsn1ParamsFn(effectiveEncryptionAlgorithm.encryptionScheme)\n    }\n  }, Pbes2Algorithms);\n  return {\n    encryptionAlgorithmParamsAsn1,\n    encryptedData\n  };\n};\nexport const maybeDecryptPrivateKeyInfo = (encryptedPrivateKeyInfoAsn1, password) => {\n  let encryptedPrivateKeyInfo;\n\n  try {\n    encryptedPrivateKeyInfo = decodeAsn1(encryptedPrivateKeyInfoAsn1, EncryptedPrivateKeyInfo);\n  } catch (err) {\n    /* istanbul ignore else */\n    if (err instanceof DecodeAsn1FailedError) {\n      return {\n        encryptionAlgorithm: null,\n        privateKeyInfoAsn1: encryptedPrivateKeyInfoAsn1\n      };\n    }\n    /* istanbul ignore next */\n\n\n    throw err;\n  }\n\n  if (!password) {\n    throw new MissingPasswordError('Please specify the password to decrypt the key');\n  }\n\n  const {\n    encryptionAlgorithm,\n    encryptedData\n  } = encryptedPrivateKeyInfo;\n  const encryptionAlgorithmId = OIDS[encryptionAlgorithm.id];\n  const encryptionAlgorithmParamsAsn1 = encryptionAlgorithm.parameters;\n  let decryptionResult;\n\n  switch (encryptionAlgorithmId) {\n    case 'pbes2':\n      decryptionResult = decryptWithPBES2(encryptedData, encryptionAlgorithmParamsAsn1, password);\n      break;\n\n    default:\n      throw new UnsupportedAlgorithmError(`Unsupported encryption algorithm OID '${encryptionAlgorithm.id}'`);\n  }\n\n  return {\n    encryptionAlgorithm: decryptionResult.encryptionAlgorithm,\n    privateKeyInfoAsn1: decryptionResult.decryptedData\n  };\n};\nexport const maybeEncryptPrivateKeyInfo = (privateKeyInfoAsn1, encryptionAlgorithm, password) => {\n  if (!password && !encryptionAlgorithm) {\n    return privateKeyInfoAsn1;\n  }\n\n  if (!password && encryptionAlgorithm) {\n    throw new MissingPasswordError('An encryption algorithm was specified but no password was set');\n  }\n\n  const {\n    encryptedData,\n    encryptionAlgorithmParamsAsn1\n  } = encryptWithPBES2(privateKeyInfoAsn1, encryptionAlgorithm, password);\n  const encryptedPrivateKeyInfoAsn1 = encodeAsn1({\n    encryptionAlgorithm: {\n      id: FLIPPED_OIDS.pbes2,\n      parameters: encryptionAlgorithmParamsAsn1\n    },\n    encryptedData\n  }, EncryptedPrivateKeyInfo);\n  return encryptedPrivateKeyInfoAsn1;\n};"]},"metadata":{},"sourceType":"module"}