{"ast":null,"code":"import _regeneratorRuntime from\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _createForOfIteratorHelper from\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";import _slicedToArray from\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useLayoutEffect,useRef}from\"react\";import*as kweb from\"@_koi/sdk/web\";import gifFrames from\"gif-frames\";import axios from'axios';// import SmartWeave from \"smartweave\";\nimport\"./App.css\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var ktools=new kweb.Web();console.log(\"ktools\",ktools);var state;var id;var koii;var totalFrames=225;function App(){var _useState=useState(/*#__PURE__*/_jsx(\"canvas\",{})),_useState2=_slicedToArray(_useState,2),narcissus=_useState2[0],setNarcissus=_useState2[1];var _useState3=useState(true),_useState4=_slicedToArray(_useState3,2),loading=_useState4[0],setLoading=_useState4[1];var _useState5=useState(0),_useState6=_slicedToArray(_useState5,2),score=_useState6[0],setScore=_useState6[1];// const [canvas, setCanvas] = useState(<canvas></canvas>);\nvar mainRef=useRef(null);useEffect(function(){init();},[]);var updateScore=function updateScore(){// for ( let child of mainRef.current.children ) {\n//   child.delete()\n// }\nconsole.log(\"useEffect score\",mainRef,'score is',score);if(!mainRef.current){console.log('not updating score because',mainRef.current);// updateScore(); // hacky - should be removed\nreturn;}else{var scoreSpan=document.createElement('span');scoreSpan.innerText=score;scoreSpan.className=\"scoreSpan\";mainRef.current.appendChild(scoreSpan);}};useLayoutEffect(function(){updateScore();// Clean up\nreturn function(){var spans=document.getElementsByClassName('scoreSpan');var _iterator=_createForOfIteratorHelper(spans),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var span=_step.value;span.remove();}}catch(err){_iterator.e(err);}finally{_iterator.f();}};},[score]);useLayoutEffect(function(){// for ( let child of mainRef.current.children ) {\n//   child.delete()\n// }\nconsole.log(\"useEffect\",mainRef);if(!mainRef.current){console.log('not updating narcissus because',mainRef.current);init();// hacky - should be removed\nreturn;}else{console.log('about to append because main is',mainRef.current,narcissus);var scoreSpan=document.createElement('span');scoreSpan.innerText=score;scoreSpan.className=\"scoreSpan\";narcissus.className='narcissus';mainRef.current.appendChild(narcissus);mainRef.current.appendChild(scoreSpan);}// Clean up\nreturn function(){console.log(\"clean up\");// mainRef.current.innerHTML = null\nvar narci=document.getElementsByClassName('narcissus');var _iterator2=_createForOfIteratorHelper(narci),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var n=_step2.value;n.remove();}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}};},[narcissus]);/* -- Functions -- */var init=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var correctFreezeFrame;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return getCorrectFreezeFrame();case 2:correctFreezeFrame=_context.sent;console.log('setting frame',correctFreezeFrame);_context.next=6;return setGif(correctFreezeFrame);case 6:return _context.abrupt(\"return\",{state:state,id:id});case 7:case\"end\":return _context.stop();}}},_callee);}));return function init(){return _ref.apply(this,arguments);};}();function getData(_x){return _getData.apply(this,arguments);}function _getData(){_getData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(url){var response;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return axios.get(url);case 3:response=_context2.sent;console.log(response);return _context2.abrupt(\"return\",response.data);case 8:_context2.prev=8;_context2.t0=_context2[\"catch\"](0);console.error(_context2.t0);case 11:case\"end\":return _context2.stop();}}},_callee2,null,[[0,8]]);}));return _getData.apply(this,arguments);}function getCorrectFreezeFrame(){return _getCorrectFreezeFrame.apply(this,arguments);}function _getCorrectFreezeFrame(){_getCorrectFreezeFrame=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var oid,nft_state,koii_state,current,lockBlock,list,newScore,change,max,scalar,last,lastMax,i,_iterator3,_step3,item,aScore,remainder;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;oid=window.location.pathname.split('/')[1]||'1ZjIecqKGYdGTFMWR9kdGrmi77lMmZnA6dxEzWulyjo';// console.log('got oid', oid)\n// var nft_state = await ktools.readNftState(oid);\n_context3.next=4;return getData('https://arweave.net/1ZjIecqKGYdGTFMWR9kdGrmi77lMmZnA6dxEzWulyjo');case 4:nft_state=_context3.sent;_context3.next=7;return getData('https://arweave.net/cETTyJQYxJLVQ6nC3VxzsZf1x2-6TW2LFkGZa91gUWc');case 7:koii_state=_context3.sent;// contract state\ncurrent=nft_state.decay.lockState||0;lockBlock=nft_state.decay.lastLock;list=koii_state.stateUpdate.trafficLogs.rewardReport;// this will contain the output\n// looping variables\nchange=0;max=nft_state.decay.lastMax||1;scalar=1;last=0;lastMax=0;i=0;_iterator3=_createForOfIteratorHelper(list);try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){item=_step3.value;// console.log('checking', i, 'change is ', change)\nif(item.dailyTrafficBlock>lockBlock){if(typeof item.logsSummary&&Object.keys(item.logsSummary).includes(oid)){aScore=item.logsSummary[oid];if(aScore<max){if(last===i-1){// if we are on a streak, incremement the scalar\nscalar=scalar+scalar;}if(i-10<lastMax){// we are in a recovery slump, so the scalar is negative now\nscalar=-1*scalar;}// increment the adjustment \nchange=change+aScore*(1+scalar/100);}else{// if we have a new max we get a major boost\nmax=aScore;lastMax=i;change=change+10000;}last=i;}}i=i+1;}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}if(change<1){// return current;\nconsole.log('returning current',current);newScore=current;// return 200;\n}else{// return current + change;\nremainder=totalFrames-current;// the maximum score adjustment we can give (total frames less current score)\nnewScore=remainder*(10001-change);if(newScore>totalFrames){newScore=totalFrames;}else if(newScore<0){newScore=0;}}// newScore = 200; // enable to check gif scrolling locally\nconsole.log('newScore is',newScore);setScore(newScore);return _context3.abrupt(\"return\",newScore);case 25:_context3.prev=25;_context3.t0=_context3[\"catch\"](0);console.log('error loading nft data',_context3.t0);setScore(1);return _context3.abrupt(\"return\",1);case 30:case\"end\":return _context3.stop();}}},_callee3,null,[[0,25]]);}));return _getCorrectFreezeFrame.apply(this,arguments);}function setGif(_x2){return _setGif.apply(this,arguments);}// const renderImage = () => {\n//   // console.log(canvas, typeof(canvas), JSON.stringify(canvas))\n//   // for ( let child of mainRef.current.children ) {\n//   //   child.delete()\n//   // }\n//   console.log('CANVAAS', canvas, typeof(canvas))\n//   let copy = canvas.cloneNode(true)\n//   mainRef.current.insertAdjacentElement('afterbegin', copy)\n// }\nfunction _setGif(){_setGif=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(frameToSet){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:return _context4.abrupt(\"return\",new Promise(function(resolve,reject){try{gifFrames({url:\"./img/narcissus.gif\",frames:\"0-1000\",outputType:\"canvas\"}).then(function(frameData){// console.log('setting frame', frameToSet, frameData[frameToSet])\nvar obj=frameData[frameToSet].getImage();setNarcissus(obj);setLoading(false);resolve(frameData);}).catch(console.error.bind(console));}catch(err){console.log(\"err\",err);reject(err);}}));case 1:case\"end\":return _context4.stop();}}},_callee4);}));return _setGif.apply(this,arguments);}return/*#__PURE__*/_jsxs(\"div\",{className:\"App\",children:[loading&&/*#__PURE__*/_jsx(\"img\",{alt:\"this is the loading icon\",src:window.location.origin+\"/img/narcissus.gif\"}),!loading&&/*#__PURE__*/_jsxs(React.Fragment,{children:[/*#__PURE__*/_jsx(\"header\",{}),/*#__PURE__*/_jsx(\"main\",{ref:mainRef}),/*#__PURE__*/_jsx(\"img\",{src:\"./img/narcissus.gif\"})]})]});}export default App;// need to fetch the attention logs from koi state\n// then, iterate over the logs and sum the total attention\n// then, check the last time the nft was updated\n// then, check the nft's decay from it's state.decay\n// then, increment counters based on the difference of current block height and the block height at last adjustment\n// then, adjust the 'durability' score","map":{"version":3,"sources":["/home/al/Desktop/koi/narcissus/content/src/App.js"],"names":["React","useState","useEffect","useLayoutEffect","useRef","kweb","gifFrames","axios","ktools","Web","console","log","state","id","koii","totalFrames","App","narcissus","setNarcissus","loading","setLoading","score","setScore","mainRef","init","updateScore","current","scoreSpan","document","createElement","innerText","className","appendChild","spans","getElementsByClassName","span","remove","narci","n","getCorrectFreezeFrame","correctFreezeFrame","setGif","getData","url","get","response","data","error","oid","window","location","pathname","split","nft_state","koii_state","decay","lockState","lockBlock","lastLock","list","stateUpdate","trafficLogs","rewardReport","change","max","lastMax","scalar","last","i","item","dailyTrafficBlock","logsSummary","Object","keys","includes","aScore","newScore","remainder","frameToSet","Promise","resolve","reject","frames","outputType","then","frameData","obj","getImage","catch","bind","err","origin"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useLayoutEffect, useRef } from \"react\";\n\nimport * as kweb from \"@_koi/sdk/web\";\nimport gifFrames from \"gif-frames\";\nimport axios from 'axios';\n\n// import SmartWeave from \"smartweave\";\n\nimport \"./App.css\";\n\nconst ktools = new kweb.Web();\n\nconsole.log(\"ktools\", ktools);\n\nlet state;\nlet id;\nlet koii;\nlet totalFrames = 225;\n\nfunction App() {\n  const [narcissus, setNarcissus] = useState(<canvas></canvas>);\n  const [loading, setLoading] = useState(true);\n  const [score, setScore] = useState(0);\n  // const [canvas, setCanvas] = useState(<canvas></canvas>);\n  const mainRef = useRef(null);\n\n  useEffect(() => {\n    init();\n  }, []);\n\n  const updateScore = () => {\n      // for ( let child of mainRef.current.children ) {\n    //   child.delete()\n    // }\n    console.log(\"useEffect score\", mainRef, 'score is', score);\n    if (!mainRef.current) {\n      console.log('not updating score because', mainRef.current)\n      // updateScore(); // hacky - should be removed\n      return;\n    } else {\n      let scoreSpan = document.createElement('span')\n          scoreSpan.innerText = score;\n          scoreSpan.className = \"scoreSpan\"\n        \n      mainRef.current.appendChild(scoreSpan);\n    }\n  }\n\n  useLayoutEffect(() => {\n    updateScore();\n\n    // Clean up\n    return () => {\n      var spans = document.getElementsByClassName('scoreSpan')\n      for ( let span of spans ) {\n        span.remove()\n      }\n    };\n  }, [score]);\n\n  useLayoutEffect(() => {\n    // for ( let child of mainRef.current.children ) {\n    //   child.delete()\n    // }\n    console.log(\"useEffect\", mainRef);\n    if (!mainRef.current) {\n      console.log('not updating narcissus because', mainRef.current)\n      init(); // hacky - should be removed\n      return;\n    } else {\n      console.log('about to append because main is', mainRef.current, narcissus)\n      let scoreSpan = document.createElement('span')\n          scoreSpan.innerText = score;\n          scoreSpan.className = \"scoreSpan\"\n      narcissus.className = 'narcissus'\n      mainRef.current.appendChild(narcissus);\n      mainRef.current.appendChild(scoreSpan);\n    }\n\n    // Clean up\n    return () => {\n      console.log(\"clean up\");\n      // mainRef.current.innerHTML = null\n      let narci = document.getElementsByClassName('narcissus')\n      for ( let n of narci ) {\n        n.remove()\n      }\n\n    };\n  }, [narcissus]);\n\n  /* -- Functions -- */\n\n  const init = async () => {\n    // should add the following flower to the view, replacing the loading icon\n    let correctFreezeFrame = await getCorrectFreezeFrame()\n    console.log('setting frame', correctFreezeFrame)\n    await setGif(correctFreezeFrame);\n\n    return { state, id };\n  };\n\n  async function getData (url) {\n    try {\n      const response = await axios.get(url);\n      console.log(response);\n      return response.data;\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  async function getCorrectFreezeFrame() {\n    try {\n      var oid = (window.location.pathname).split('/')[1] || '1ZjIecqKGYdGTFMWR9kdGrmi77lMmZnA6dxEzWulyjo';\n      // console.log('got oid', oid)\n      // var nft_state = await ktools.readNftState(oid);\n      var nft_state = await getData('https://arweave.net/1ZjIecqKGYdGTFMWR9kdGrmi77lMmZnA6dxEzWulyjo')\n      \n      // var koii_state = await ktools.getContractState();\n      var koii_state = await getData('https://arweave.net/cETTyJQYxJLVQ6nC3VxzsZf1x2-6TW2LFkGZa91gUWc');\n\n      // contract state\n      let current = nft_state.decay.lockState || 0;\n      let lockBlock = nft_state.decay.lastLock;\n      let list = koii_state.stateUpdate.trafficLogs.rewardReport;\n      let newScore; // this will contain the output\n\n      // looping variables\n      let change = 0;\n      let max = nft_state.decay.lastMax || 1;\n      let scalar = 1;\n      let last = 0;\n      let lastMax = 0;\n      let i = 0;\n\n      for ( var item of list ) {\n        // console.log('checking', i, 'change is ', change)\n        if ( item.dailyTrafficBlock > lockBlock ) { \n            if ( typeof(item.logsSummary) && Object.keys(item.logsSummary).includes(oid) ) {\n              let aScore = item.logsSummary[oid];\n              if ( aScore < max ) {\n                \n                if ( last === i - 1 ) {\n                  // if we are on a streak, incremement the scalar\n                  scalar = scalar + scalar;\n                }\n                \n                if ( ( i - 10 ) < lastMax ) {\n                  // we are in a recovery slump, so the scalar is negative now\n                  scalar = ( -1 ) * scalar;\n                }\n                \n                // increment the adjustment \n                change = change + aScore * ( 1 + scalar / 100 )\n\n              } else {\n                // if we have a new max we get a major boost\n                max = aScore;\n                lastMax = i;\n                change = change + 10000;\n              }\n              last = i;\n            }\n        }\n        i = i + 1;\n      }\n      \n      if (change < 1) {\n        // return current;\n        console.log('returning current', current)\n        newScore = current;\n        // return 200;\n      } else {\n        // return current + change;\n        let remainder = totalFrames - current; // the maximum score adjustment we can give (total frames less current score)\n        newScore = remainder * ( 10001 - change );\n        if ( newScore > totalFrames ) {\n          newScore = totalFrames;\n        } else if ( newScore < 0 ) {\n          newScore = 0;\n        }\n      }\n      // newScore = 200; // enable to check gif scrolling locally\n      console.log('newScore is', newScore)\n      setScore(newScore);\n      return newScore;\n    } catch (err) {\n      console.log('error loading nft data', err)\n      setScore(1)\n      return 1;\n    }\n  }\n\n  async function setGif(frameToSet) {\n    return new Promise(function (resolve, reject) {\n      try {\n        gifFrames({ url: \"./img/narcissus.gif\", frames: \"0-1000\", outputType: \"canvas\" })\n          .then(function (frameData) {\n            // console.log('setting frame', frameToSet, frameData[frameToSet])\n            let obj = frameData[frameToSet].getImage();\n            setNarcissus(obj);\n            setLoading(false);\n            resolve(frameData);\n          })\n          .catch(console.error.bind(console));\n      } catch (err) {\n        console.log(\"err\", err);\n        reject(err);\n      }\n    });\n  }\n\n  // const renderImage = () => {\n\n  //   // console.log(canvas, typeof(canvas), JSON.stringify(canvas))\n\n  //   // for ( let child of mainRef.current.children ) {\n  //   //   child.delete()\n  //   // }\n\n  //   console.log('CANVAAS', canvas, typeof(canvas))\n\n  //   let copy = canvas.cloneNode(true)\n\n  //   mainRef.current.insertAdjacentElement('afterbegin', copy)\n  // }\n\n  return (\n    <div className=\"App\">\n      {loading && (\n        <img alt=\"this is the loading icon\" src={window.location.origin + \"/img/narcissus.gif\"} />\n      )}\n      {!loading && (\n        <React.Fragment>\n          <header></header>\n          <main ref={mainRef}></main>\n          <img src=\"./img/narcissus.gif\"></img>\n        </React.Fragment>\n      )}\n    </div>\n  );\n}\n\nexport default App;\n\n// need to fetch the attention logs from koi state\n// then, iterate over the logs and sum the total attention\n// then, check the last time the nft was updated\n// then, check the nft's decay from it's state.decay\n// then, increment counters based on the difference of current block height and the block height at last adjustment\n// then, adjust the 'durability' score\n"]},"metadata":{},"sourceType":"module"}