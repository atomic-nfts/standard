{"ast":null,"code":"'use strict';\n\nvar constants = require('./constants');\n\nvar CrcCalculator = require('./crc');\n\nvar Parser = module.exports = function (options, dependencies) {\n  this._options = options;\n  options.checkCRC = options.checkCRC !== false;\n  this._hasIHDR = false;\n  this._hasIEND = false; // input flags/metadata\n\n  this._palette = [];\n  this._colorType = 0;\n  this._chunks = {};\n  this._chunks[constants.TYPE_IHDR] = this._handleIHDR.bind(this);\n  this._chunks[constants.TYPE_IEND] = this._handleIEND.bind(this);\n  this._chunks[constants.TYPE_IDAT] = this._handleIDAT.bind(this);\n  this._chunks[constants.TYPE_PLTE] = this._handlePLTE.bind(this);\n  this._chunks[constants.TYPE_tRNS] = this._handleTRNS.bind(this);\n  this._chunks[constants.TYPE_gAMA] = this._handleGAMA.bind(this);\n  this.read = dependencies.read;\n  this.error = dependencies.error;\n  this.metadata = dependencies.metadata;\n  this.gamma = dependencies.gamma;\n  this.transColor = dependencies.transColor;\n  this.palette = dependencies.palette;\n  this.parsed = dependencies.parsed;\n  this.inflateData = dependencies.inflateData;\n  this.inflateData = dependencies.inflateData;\n  this.finished = dependencies.finished;\n};\n\nParser.prototype.start = function () {\n  this.read(constants.PNG_SIGNATURE.length, this._parseSignature.bind(this));\n};\n\nParser.prototype._parseSignature = function (data) {\n  var signature = constants.PNG_SIGNATURE;\n\n  for (var i = 0; i < signature.length; i++) {\n    if (data[i] !== signature[i]) {\n      this.error(new Error('Invalid file signature'));\n      return;\n    }\n  }\n\n  this.read(8, this._parseChunkBegin.bind(this));\n};\n\nParser.prototype._parseChunkBegin = function (data) {\n  // chunk content length\n  var length = data.readUInt32BE(0); // chunk type\n\n  var type = data.readUInt32BE(4);\n  var name = '';\n\n  for (var i = 4; i < 8; i++) {\n    name += String.fromCharCode(data[i]);\n  } //console.log('chunk ', name, length);\n  // chunk flags\n\n\n  var ancillary = Boolean(data[4] & 0x20); // or critical\n  //    priv = Boolean(data[5] & 0x20), // or public\n  //    safeToCopy = Boolean(data[7] & 0x20); // or unsafe\n\n  if (!this._hasIHDR && type !== constants.TYPE_IHDR) {\n    this.error(new Error('Expected IHDR on beggining'));\n    return;\n  }\n\n  this._crc = new CrcCalculator();\n\n  this._crc.write(new Buffer(name));\n\n  if (this._chunks[type]) {\n    return this._chunks[type](length);\n  }\n\n  if (!ancillary) {\n    this.error(new Error('Unsupported critical chunk type ' + name));\n    return;\n  }\n\n  this.read(length + 4, this._skipChunk.bind(this));\n};\n\nParser.prototype._skipChunk = function ()\n/*data*/\n{\n  this.read(8, this._parseChunkBegin.bind(this));\n};\n\nParser.prototype._handleChunkEnd = function () {\n  this.read(4, this._parseChunkEnd.bind(this));\n};\n\nParser.prototype._parseChunkEnd = function (data) {\n  var fileCrc = data.readInt32BE(0);\n\n  var calcCrc = this._crc.crc32(); // check CRC\n\n\n  if (this._options.checkCRC && calcCrc !== fileCrc) {\n    this.error(new Error('Crc error - ' + fileCrc + ' - ' + calcCrc));\n    return;\n  }\n\n  if (!this._hasIEND) {\n    this.read(8, this._parseChunkBegin.bind(this));\n  }\n};\n\nParser.prototype._handleIHDR = function (length) {\n  this.read(length, this._parseIHDR.bind(this));\n};\n\nParser.prototype._parseIHDR = function (data) {\n  this._crc.write(data);\n\n  var width = data.readUInt32BE(0);\n  var height = data.readUInt32BE(4);\n  var depth = data[8];\n  var colorType = data[9]; // bits: 1 palette, 2 color, 4 alpha\n\n  var compr = data[10];\n  var filter = data[11];\n  var interlace = data[12]; // console.log('    width', width, 'height', height,\n  //     'depth', depth, 'colorType', colorType,\n  //     'compr', compr, 'filter', filter, 'interlace', interlace\n  // );\n\n  if (depth !== 8 && depth !== 4 && depth !== 2 && depth !== 1 && depth !== 16) {\n    this.error(new Error('Unsupported bit depth ' + depth));\n    return;\n  }\n\n  if (!(colorType in constants.COLORTYPE_TO_BPP_MAP)) {\n    this.error(new Error('Unsupported color type'));\n    return;\n  }\n\n  if (compr !== 0) {\n    this.error(new Error('Unsupported compression method'));\n    return;\n  }\n\n  if (filter !== 0) {\n    this.error(new Error('Unsupported filter method'));\n    return;\n  }\n\n  if (interlace !== 0 && interlace !== 1) {\n    this.error(new Error('Unsupported interlace method'));\n    return;\n  }\n\n  this._colorType = colorType;\n  var bpp = constants.COLORTYPE_TO_BPP_MAP[this._colorType];\n  this._hasIHDR = true;\n  this.metadata({\n    width: width,\n    height: height,\n    depth: depth,\n    interlace: Boolean(interlace),\n    palette: Boolean(colorType & constants.COLORTYPE_PALETTE),\n    color: Boolean(colorType & constants.COLORTYPE_COLOR),\n    alpha: Boolean(colorType & constants.COLORTYPE_ALPHA),\n    bpp: bpp,\n    colorType: colorType\n  });\n\n  this._handleChunkEnd();\n};\n\nParser.prototype._handlePLTE = function (length) {\n  this.read(length, this._parsePLTE.bind(this));\n};\n\nParser.prototype._parsePLTE = function (data) {\n  this._crc.write(data);\n\n  var entries = Math.floor(data.length / 3); // console.log('Palette:', entries);\n\n  for (var i = 0; i < entries; i++) {\n    this._palette.push([data[i * 3], data[i * 3 + 1], data[i * 3 + 2], 0xff]);\n  }\n\n  this.palette(this._palette);\n\n  this._handleChunkEnd();\n};\n\nParser.prototype._handleTRNS = function (length) {\n  this.read(length, this._parseTRNS.bind(this));\n};\n\nParser.prototype._parseTRNS = function (data) {\n  this._crc.write(data); // palette\n\n\n  if (this._colorType === constants.COLORTYPE_PALETTE_COLOR) {\n    if (this._palette.length === 0) {\n      this.error(new Error('Transparency chunk must be after palette'));\n      return;\n    }\n\n    if (data.length > this._palette.length) {\n      this.error(new Error('More transparent colors than palette size'));\n      return;\n    }\n\n    for (var i = 0; i < data.length; i++) {\n      this._palette[i][3] = data[i];\n    }\n\n    this.palette(this._palette);\n  } // for colorType 0 (grayscale) and 2 (rgb)\n  // there might be one gray/color defined as transparent\n\n\n  if (this._colorType === constants.COLORTYPE_GRAYSCALE) {\n    // grey, 2 bytes\n    this.transColor([data.readUInt16BE(0)]);\n  }\n\n  if (this._colorType === constants.COLORTYPE_COLOR) {\n    this.transColor([data.readUInt16BE(0), data.readUInt16BE(2), data.readUInt16BE(4)]);\n  }\n\n  this._handleChunkEnd();\n};\n\nParser.prototype._handleGAMA = function (length) {\n  this.read(length, this._parseGAMA.bind(this));\n};\n\nParser.prototype._parseGAMA = function (data) {\n  this._crc.write(data);\n\n  this.gamma(data.readUInt32BE(0) / constants.GAMMA_DIVISION);\n\n  this._handleChunkEnd();\n};\n\nParser.prototype._handleIDAT = function (length) {\n  this.read(-length, this._parseIDAT.bind(this, length));\n};\n\nParser.prototype._parseIDAT = function (length, data) {\n  this._crc.write(data);\n\n  if (this._colorType === constants.COLORTYPE_PALETTE_COLOR && this._palette.length === 0) {\n    throw new Error('Expected palette not found');\n  }\n\n  this.inflateData(data);\n  var leftOverLength = length - data.length;\n\n  if (leftOverLength > 0) {\n    this._handleIDAT(leftOverLength);\n  } else {\n    this._handleChunkEnd();\n  }\n};\n\nParser.prototype._handleIEND = function (length) {\n  this.read(length, this._parseIEND.bind(this));\n};\n\nParser.prototype._parseIEND = function (data) {\n  this._crc.write(data);\n\n  this._hasIEND = true;\n\n  this._handleChunkEnd();\n\n  if (this.finished) {\n    this.finished();\n  }\n};","map":{"version":3,"sources":["/home/al/Desktop/koi/narcissus/content/node_modules/pngjs-nozlib/lib/parser.js"],"names":["constants","require","CrcCalculator","Parser","module","exports","options","dependencies","_options","checkCRC","_hasIHDR","_hasIEND","_palette","_colorType","_chunks","TYPE_IHDR","_handleIHDR","bind","TYPE_IEND","_handleIEND","TYPE_IDAT","_handleIDAT","TYPE_PLTE","_handlePLTE","TYPE_tRNS","_handleTRNS","TYPE_gAMA","_handleGAMA","read","error","metadata","gamma","transColor","palette","parsed","inflateData","finished","prototype","start","PNG_SIGNATURE","length","_parseSignature","data","signature","i","Error","_parseChunkBegin","readUInt32BE","type","name","String","fromCharCode","ancillary","Boolean","_crc","write","Buffer","_skipChunk","_handleChunkEnd","_parseChunkEnd","fileCrc","readInt32BE","calcCrc","crc32","_parseIHDR","width","height","depth","colorType","compr","filter","interlace","COLORTYPE_TO_BPP_MAP","bpp","COLORTYPE_PALETTE","color","COLORTYPE_COLOR","alpha","COLORTYPE_ALPHA","_parsePLTE","entries","Math","floor","push","_parseTRNS","COLORTYPE_PALETTE_COLOR","COLORTYPE_GRAYSCALE","readUInt16BE","_parseGAMA","GAMMA_DIVISION","_parseIDAT","leftOverLength","_parseIEND"],"mappings":"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","sourcesContent":["'use strict';\n\nvar constants = require('./constants');\nvar CrcCalculator = require('./crc');\n\n\nvar Parser = module.exports = function(options, dependencies) {\n\n  this._options = options;\n  options.checkCRC = options.checkCRC !== false;\n\n  this._hasIHDR = false;\n  this._hasIEND = false;\n\n  // input flags/metadata\n  this._palette = [];\n  this._colorType = 0;\n\n  this._chunks = {};\n  this._chunks[constants.TYPE_IHDR] = this._handleIHDR.bind(this);\n  this._chunks[constants.TYPE_IEND] = this._handleIEND.bind(this);\n  this._chunks[constants.TYPE_IDAT] = this._handleIDAT.bind(this);\n  this._chunks[constants.TYPE_PLTE] = this._handlePLTE.bind(this);\n  this._chunks[constants.TYPE_tRNS] = this._handleTRNS.bind(this);\n  this._chunks[constants.TYPE_gAMA] = this._handleGAMA.bind(this);\n\n  this.read = dependencies.read;\n  this.error = dependencies.error;\n  this.metadata = dependencies.metadata;\n  this.gamma = dependencies.gamma;\n  this.transColor = dependencies.transColor;\n  this.palette = dependencies.palette;\n  this.parsed = dependencies.parsed;\n  this.inflateData = dependencies.inflateData;\n  this.inflateData = dependencies.inflateData;\n  this.finished = dependencies.finished;\n};\n\nParser.prototype.start = function() {\n  this.read(constants.PNG_SIGNATURE.length,\n    this._parseSignature.bind(this)\n  );\n};\n\nParser.prototype._parseSignature = function(data) {\n\n  var signature = constants.PNG_SIGNATURE;\n\n  for (var i = 0; i < signature.length; i++) {\n    if (data[i] !== signature[i]) {\n      this.error(new Error('Invalid file signature'));\n      return;\n    }\n  }\n  this.read(8, this._parseChunkBegin.bind(this));\n};\n\nParser.prototype._parseChunkBegin = function(data) {\n\n  // chunk content length\n  var length = data.readUInt32BE(0);\n\n  // chunk type\n  var type = data.readUInt32BE(4);\n  var name = '';\n  for (var i = 4; i < 8; i++) {\n    name += String.fromCharCode(data[i]);\n  }\n\n  //console.log('chunk ', name, length);\n\n  // chunk flags\n  var ancillary = Boolean(data[4] & 0x20); // or critical\n//    priv = Boolean(data[5] & 0x20), // or public\n//    safeToCopy = Boolean(data[7] & 0x20); // or unsafe\n\n  if (!this._hasIHDR && type !== constants.TYPE_IHDR) {\n    this.error(new Error('Expected IHDR on beggining'));\n    return;\n  }\n\n  this._crc = new CrcCalculator();\n  this._crc.write(new Buffer(name));\n\n  if (this._chunks[type]) {\n    return this._chunks[type](length);\n  }\n\n  if (!ancillary) {\n    this.error(new Error('Unsupported critical chunk type ' + name));\n    return;\n  }\n\n  this.read(length + 4, this._skipChunk.bind(this));\n};\n\nParser.prototype._skipChunk = function(/*data*/) {\n  this.read(8, this._parseChunkBegin.bind(this));\n};\n\nParser.prototype._handleChunkEnd = function() {\n  this.read(4, this._parseChunkEnd.bind(this));\n};\n\nParser.prototype._parseChunkEnd = function(data) {\n\n  var fileCrc = data.readInt32BE(0);\n  var calcCrc = this._crc.crc32();\n\n  // check CRC\n  if (this._options.checkCRC && calcCrc !== fileCrc) {\n    this.error(new Error('Crc error - ' + fileCrc + ' - ' + calcCrc));\n    return;\n  }\n\n  if (!this._hasIEND) {\n    this.read(8, this._parseChunkBegin.bind(this));\n  }\n};\n\nParser.prototype._handleIHDR = function(length) {\n  this.read(length, this._parseIHDR.bind(this));\n};\nParser.prototype._parseIHDR = function(data) {\n\n  this._crc.write(data);\n\n  var width = data.readUInt32BE(0);\n  var height = data.readUInt32BE(4);\n  var depth = data[8];\n  var colorType = data[9]; // bits: 1 palette, 2 color, 4 alpha\n  var compr = data[10];\n  var filter = data[11];\n  var interlace = data[12];\n\n  // console.log('    width', width, 'height', height,\n  //     'depth', depth, 'colorType', colorType,\n  //     'compr', compr, 'filter', filter, 'interlace', interlace\n  // );\n\n  if (depth !== 8 && depth !== 4 && depth !== 2 && depth !== 1 && depth !== 16) {\n    this.error(new Error('Unsupported bit depth ' + depth));\n    return;\n  }\n  if (!(colorType in constants.COLORTYPE_TO_BPP_MAP)) {\n    this.error(new Error('Unsupported color type'));\n    return;\n  }\n  if (compr !== 0) {\n    this.error(new Error('Unsupported compression method'));\n    return;\n  }\n  if (filter !== 0) {\n    this.error(new Error('Unsupported filter method'));\n    return;\n  }\n  if (interlace !== 0 && interlace !== 1) {\n    this.error(new Error('Unsupported interlace method'));\n    return;\n  }\n\n  this._colorType = colorType;\n\n  var bpp = constants.COLORTYPE_TO_BPP_MAP[this._colorType];\n\n  this._hasIHDR = true;\n\n  this.metadata({\n    width: width,\n    height: height,\n    depth: depth,\n    interlace: Boolean(interlace),\n    palette: Boolean(colorType & constants.COLORTYPE_PALETTE),\n    color: Boolean(colorType & constants.COLORTYPE_COLOR),\n    alpha: Boolean(colorType & constants.COLORTYPE_ALPHA),\n    bpp: bpp,\n    colorType: colorType\n  });\n\n  this._handleChunkEnd();\n};\n\n\nParser.prototype._handlePLTE = function(length) {\n  this.read(length, this._parsePLTE.bind(this));\n};\nParser.prototype._parsePLTE = function(data) {\n\n  this._crc.write(data);\n\n  var entries = Math.floor(data.length / 3);\n  // console.log('Palette:', entries);\n\n  for (var i = 0; i < entries; i++) {\n    this._palette.push([\n      data[i * 3],\n      data[i * 3 + 1],\n      data[i * 3 + 2],\n      0xff\n    ]);\n  }\n\n  this.palette(this._palette);\n\n  this._handleChunkEnd();\n};\n\nParser.prototype._handleTRNS = function(length) {\n  this.read(length, this._parseTRNS.bind(this));\n};\nParser.prototype._parseTRNS = function(data) {\n\n  this._crc.write(data);\n\n  // palette\n  if (this._colorType === constants.COLORTYPE_PALETTE_COLOR) {\n    if (this._palette.length === 0) {\n      this.error(new Error('Transparency chunk must be after palette'));\n      return;\n    }\n    if (data.length > this._palette.length) {\n      this.error(new Error('More transparent colors than palette size'));\n      return;\n    }\n    for (var i = 0; i < data.length; i++) {\n      this._palette[i][3] = data[i];\n    }\n    this.palette(this._palette);\n  }\n\n  // for colorType 0 (grayscale) and 2 (rgb)\n  // there might be one gray/color defined as transparent\n  if (this._colorType === constants.COLORTYPE_GRAYSCALE) {\n    // grey, 2 bytes\n    this.transColor([data.readUInt16BE(0)]);\n  }\n  if (this._colorType === constants.COLORTYPE_COLOR) {\n    this.transColor([data.readUInt16BE(0), data.readUInt16BE(2), data.readUInt16BE(4)]);\n  }\n\n  this._handleChunkEnd();\n};\n\nParser.prototype._handleGAMA = function(length) {\n  this.read(length, this._parseGAMA.bind(this));\n};\nParser.prototype._parseGAMA = function(data) {\n\n  this._crc.write(data);\n  this.gamma(data.readUInt32BE(0) / constants.GAMMA_DIVISION);\n\n  this._handleChunkEnd();\n};\n\nParser.prototype._handleIDAT = function(length) {\n  this.read(-length, this._parseIDAT.bind(this, length));\n};\nParser.prototype._parseIDAT = function(length, data) {\n\n  this._crc.write(data);\n\n  if (this._colorType === constants.COLORTYPE_PALETTE_COLOR && this._palette.length === 0) {\n    throw new Error('Expected palette not found');\n  }\n\n  this.inflateData(data);\n  var leftOverLength = length - data.length;\n\n  if (leftOverLength > 0) {\n    this._handleIDAT(leftOverLength);\n  }\n  else {\n    this._handleChunkEnd();\n  }\n};\n\nParser.prototype._handleIEND = function(length) {\n  this.read(length, this._parseIEND.bind(this));\n};\nParser.prototype._parseIEND = function(data) {\n\n  this._crc.write(data);\n\n  this._hasIEND = true;\n  this._handleChunkEnd();\n\n  if (this.finished) {\n    this.finished();\n  }\n};\n"]},"metadata":{},"sourceType":"script"}