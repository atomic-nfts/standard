{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.createContractExecutionEnvironment = exports.loadContract = void 0;\n\nconst clarity = __importStar(require(\"@weavery/clarity\"));\n\nconst utils_1 = require(\"./utils\");\n\nconst smartweave_global_1 = require(\"./smartweave-global\");\n\nconst bignumber_js_1 = __importDefault(require(\"bignumber.js\"));\n/**\n * Loads the contract source, initial state and other parameters\n *\n * @param arweave     an Arweave client instance\n * @param contractID  the Transaction Id of the contract\n */\n\n\nfunction loadContract(arweave, contractID, contractSrcTXID) {\n  return __awaiter(this, void 0, void 0, function* () {\n    // Generate an object containing the details about a contract in one place.\n    const contractTX = yield arweave.transactions.get(contractID);\n    const contractOwner = yield arweave.wallets.ownerToAddress(contractTX.owner);\n    contractSrcTXID = contractSrcTXID || utils_1.getTag(contractTX, 'Contract-Src');\n    const minFee = utils_1.getTag(contractTX, 'Min-Fee');\n    const contractSrcTX = yield arweave.transactions.get(contractSrcTXID);\n    const contractSrc = contractSrcTX.get('data', {\n      decode: true,\n      string: true\n    });\n    let state;\n\n    if (utils_1.getTag(contractTX, 'Init-State')) {\n      state = utils_1.getTag(contractTX, 'Init-State');\n    } else if (utils_1.getTag(contractTX, 'Init-State-TX')) {\n      const stateTX = yield arweave.transactions.get(utils_1.getTag(contractTX, 'Init-State-TX'));\n      state = stateTX.get('data', {\n        decode: true,\n        string: true\n      });\n    } else {\n      state = contractTX.get('data', {\n        decode: true,\n        string: true\n      });\n    }\n\n    const {\n      handler,\n      swGlobal\n    } = createContractExecutionEnvironment(arweave, contractSrc, contractID, contractOwner);\n    return {\n      id: contractID,\n      contractSrc,\n      initState: state,\n      minFee,\n      contractTX,\n      handler,\n      swGlobal\n    };\n  });\n}\n\nexports.loadContract = loadContract;\n/**\n * Translates a contract source code into a Js function that can be called, and sets\n * up two globals, SmartWeave and the ContractError exception.\n *\n * At the moment this uses the Function() constructor (basically the same as eval),\n * But the design is geared toward switching to Realms or something like\n * https://github.com/justjake/quickjs-emscripten. (probably the latter)\n *\n * In the current implemention, using Function(), the 'globals' are actually\n * just lexically scoped vars, unique to each instance of a contract.\n *\n * @param contractSrc the javascript source for the contract. Must declare a handle() function\n */\n\nfunction createContractExecutionEnvironment(arweave, contractSrc, contractId, contractOwner) {\n  const returningSrc = utils_1.normalizeContractSource(contractSrc);\n  const swGlobal = new smartweave_global_1.SmartWeaveGlobal(arweave, {\n    id: contractId,\n    owner: contractOwner\n  });\n  const getContractFunction = new Function(returningSrc); // eslint-disable-line\n\n  return {\n    handler: getContractFunction(swGlobal, bignumber_js_1.default, clarity),\n    swGlobal\n  };\n}\n\nexports.createContractExecutionEnvironment = createContractExecutionEnvironment;","map":{"version":3,"sources":["/home/al/Desktop/koi/narcissus/content/node_modules/@kyve/contract-lib/node_modules/smartweave/lib/contract-load.js"],"names":["__createBinding","Object","create","o","m","k","k2","undefined","defineProperty","enumerable","get","__setModuleDefault","v","value","__importStar","mod","__esModule","result","prototype","hasOwnProperty","call","__awaiter","thisArg","_arguments","P","generator","adopt","resolve","Promise","reject","fulfilled","step","next","e","rejected","done","then","apply","__importDefault","exports","createContractExecutionEnvironment","loadContract","clarity","require","utils_1","smartweave_global_1","bignumber_js_1","arweave","contractID","contractSrcTXID","contractTX","transactions","contractOwner","wallets","ownerToAddress","owner","getTag","minFee","contractSrcTX","contractSrc","decode","string","state","stateTX","handler","swGlobal","id","initState","contractId","returningSrc","normalizeContractSource","SmartWeaveGlobal","getContractFunction","Function","default"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.createContractExecutionEnvironment = exports.loadContract = void 0;\nconst clarity = __importStar(require(\"@weavery/clarity\"));\nconst utils_1 = require(\"./utils\");\nconst smartweave_global_1 = require(\"./smartweave-global\");\nconst bignumber_js_1 = __importDefault(require(\"bignumber.js\"));\n/**\n * Loads the contract source, initial state and other parameters\n *\n * @param arweave     an Arweave client instance\n * @param contractID  the Transaction Id of the contract\n */\nfunction loadContract(arweave, contractID, contractSrcTXID) {\n    return __awaiter(this, void 0, void 0, function* () {\n        // Generate an object containing the details about a contract in one place.\n        const contractTX = yield arweave.transactions.get(contractID);\n        const contractOwner = yield arweave.wallets.ownerToAddress(contractTX.owner);\n        contractSrcTXID = contractSrcTXID || utils_1.getTag(contractTX, 'Contract-Src');\n        const minFee = utils_1.getTag(contractTX, 'Min-Fee');\n        const contractSrcTX = yield arweave.transactions.get(contractSrcTXID);\n        const contractSrc = contractSrcTX.get('data', { decode: true, string: true });\n        let state;\n        if (utils_1.getTag(contractTX, 'Init-State')) {\n            state = utils_1.getTag(contractTX, 'Init-State');\n        }\n        else if (utils_1.getTag(contractTX, 'Init-State-TX')) {\n            const stateTX = yield arweave.transactions.get(utils_1.getTag(contractTX, 'Init-State-TX'));\n            state = stateTX.get('data', { decode: true, string: true });\n        }\n        else {\n            state = contractTX.get('data', { decode: true, string: true });\n        }\n        const { handler, swGlobal } = createContractExecutionEnvironment(arweave, contractSrc, contractID, contractOwner);\n        return {\n            id: contractID,\n            contractSrc,\n            initState: state,\n            minFee,\n            contractTX,\n            handler,\n            swGlobal,\n        };\n    });\n}\nexports.loadContract = loadContract;\n/**\n * Translates a contract source code into a Js function that can be called, and sets\n * up two globals, SmartWeave and the ContractError exception.\n *\n * At the moment this uses the Function() constructor (basically the same as eval),\n * But the design is geared toward switching to Realms or something like\n * https://github.com/justjake/quickjs-emscripten. (probably the latter)\n *\n * In the current implemention, using Function(), the 'globals' are actually\n * just lexically scoped vars, unique to each instance of a contract.\n *\n * @param contractSrc the javascript source for the contract. Must declare a handle() function\n */\nfunction createContractExecutionEnvironment(arweave, contractSrc, contractId, contractOwner) {\n    const returningSrc = utils_1.normalizeContractSource(contractSrc);\n    const swGlobal = new smartweave_global_1.SmartWeaveGlobal(arweave, { id: contractId, owner: contractOwner });\n    const getContractFunction = new Function(returningSrc); // eslint-disable-line\n    return {\n        handler: getContractFunction(swGlobal, bignumber_js_1.default, clarity),\n        swGlobal,\n    };\n}\nexports.createContractExecutionEnvironment = createContractExecutionEnvironment;\n"]},"metadata":{},"sourceType":"script"}