{"ast":null,"code":"import _regeneratorRuntime from\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _createForOfIteratorHelper from\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";import _slicedToArray from\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect,useLayoutEffect,useRef}from\"react\";// import * as kweb from \"@_koi/sdk/web\";\n// import gifFrames from \"gif-frames\";\nimport axios from'axios';import media from\"./narcissus.json\";// import SmartWeave from \"smartweave\";\nimport\"./App.css\";// console.log('narcissus', media, media.length)\n// const ktools = new kweb.Web();\n// console.log(\"ktools\", ktools);\nimport{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var state;var id;// let koii;\nvar totalFrames=225;function App(){var _useState=useState(/*#__PURE__*/_jsx(\"canvas\",{})),_useState2=_slicedToArray(_useState,2),narcissus=_useState2[0],setNarcissus=_useState2[1];var _useState3=useState(true),_useState4=_slicedToArray(_useState3,2),loading=_useState4[0],setLoading=_useState4[1];var _useState5=useState(0),_useState6=_slicedToArray(_useState5,2),score=_useState6[0],setScore=_useState6[1];// const [canvas, setCanvas] = useState(<canvas></canvas>);\nvar mainRef=useRef(null);var flower=media;var updateScore=function updateScore(){console.log(\"useEffect score\",mainRef,'score is',score);if(!mainRef.current){console.log('not updating score because',mainRef.current);// setTimeout(updateScore, 1000)\nreturn;}else{var scoreSpan=document.createElement('span');scoreSpan.innerText=score;scoreSpan.className=\"scoreSpan\";mainRef.current.appendChild(scoreSpan);}};function updateImage(){console.log(\"update narcissus\",mainRef);if(!mainRef.current){console.log('not updating narcissus because',mainRef.current);return;}else{console.log('about to append because main is',mainRef.current);var blob=new Blob([narcissus],{type:'image/svg+xml'});var url=URL.createObjectURL(blob);console.log('got url',url);var image=document.createElement('img');// image.addEventListener('onload', () => URL.revokeObjectURL(url), {once: true});\nimage.src=url;image.className=\"narcissus\";console.log('image',image);mainRef.current.appendChild(image);}}useLayoutEffect(function(){console.log('triggered score update');updateScore();// Clean up\nreturn function(){var spans=document.getElementsByClassName('scoreSpan');var _iterator=_createForOfIteratorHelper(spans),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var span=_step.value;span.remove();}}catch(err){_iterator.e(err);}finally{_iterator.f();}};},[score]);useLayoutEffect(function(){console.log('triggered image update');updateImage();// Clean up\nreturn function(){// console.log(\"clean up\");\n// // mainRef.current.innerHTML = null\nvar narci=document.getElementsByClassName('narcissus');var _iterator2=_createForOfIteratorHelper(narci),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var n=_step2.value;n.remove();}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}};},[narcissus]);/* -- Functions -- */var init=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var correctFreezeFrame;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return getCorrectFreezeFrame();case 2:correctFreezeFrame=_context.sent;console.log('setting frame',correctFreezeFrame);_context.next=6;return setSVG(correctFreezeFrame);case 6:return _context.abrupt(\"return\",{state:state,id:id});case 7:case\"end\":return _context.stop();}}},_callee);}));return function init(){return _ref.apply(this,arguments);};}();function getData(_x){return _getData.apply(this,arguments);}function _getData(){_getData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(url){var response;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return axios.get(url);case 3:response=_context2.sent;console.log(response);return _context2.abrupt(\"return\",response.data);case 8:_context2.prev=8;_context2.t0=_context2[\"catch\"](0);console.error(_context2.t0);case 11:case\"end\":return _context2.stop();}}},_callee2,null,[[0,8]]);}));return _getData.apply(this,arguments);}function getCorrectFreezeFrame(){return _getCorrectFreezeFrame.apply(this,arguments);}function _getCorrectFreezeFrame(){_getCorrectFreezeFrame=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var oid,nft_state,koii_state,current,lockBlock,list,newScore,change,max,scalar,last,lastMax,i,_iterator3,_step3,item,aScore,remainder;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;oid=window.location.pathname.split('/')[1]||'1ZjIecqKGYdGTFMWR9kdGrmi77lMmZnA6dxEzWulyjo';// console.log('got oid', oid)\n// var nft_state = await ktools.readNftState(oid);\n_context3.next=4;return getData('https://arweave.net/1ZjIecqKGYdGTFMWR9kdGrmi77lMmZnA6dxEzWulyjo');case 4:nft_state=_context3.sent;_context3.next=7;return getData('https://arweave.net/cETTyJQYxJLVQ6nC3VxzsZf1x2-6TW2LFkGZa91gUWc');case 7:koii_state=_context3.sent;// contract state\ncurrent=nft_state.decay.lockState||0;lockBlock=nft_state.decay.lastLock;list=koii_state.stateUpdate.trafficLogs.rewardReport;// this will contain the output\n// looping variables\nchange=0;max=nft_state.decay.lastMax||1;scalar=1;last=0;lastMax=0;i=0;_iterator3=_createForOfIteratorHelper(list);try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){item=_step3.value;// console.log('checking', i, 'change is ', change)\nif(item.dailyTrafficBlock>lockBlock){if(typeof item.logsSummary&&Object.keys(item.logsSummary).includes(oid)){aScore=item.logsSummary[oid];if(aScore<max){if(last===i-1){// if we are on a streak, incremement the scalar\nscalar=scalar+scalar;}if(i-10<lastMax){// we are in a recovery slump, so the scalar is negative now\nscalar=-1*scalar;}// increment the adjustment \nchange=change+aScore*(1+scalar/100);}else{// if we have a new max we get a major boost\nmax=aScore;lastMax=i;change=change+10000;}last=i;}}i=i+1;}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}if(change<1){// return current;\nconsole.log('returning current',current);newScore=current;// return 200;\n}else{// return current + change;\nremainder=totalFrames-current;// the maximum score adjustment we can give (total frames less current score)\nnewScore=remainder*(10001-change);if(newScore>totalFrames){newScore=totalFrames;}else if(newScore<0){newScore=0;}}// newScore = 200; // enable to check gif scrolling locally\nconsole.log('newScore is',newScore);// setScore(newScore);\nreturn _context3.abrupt(\"return\",newScore);case 24:_context3.prev=24;_context3.t0=_context3[\"catch\"](0);console.log('error loading nft data',_context3.t0);setScore(1);return _context3.abrupt(\"return\",1);case 29:case\"end\":return _context3.stop();}}},_callee3,null,[[0,24]]);}));return _getCorrectFreezeFrame.apply(this,arguments);}function setSVG(_x2){return _setSVG.apply(this,arguments);}// function getSVGContents(inputString){\n//     let domParser = new DOMParser();\n//     let svgDOM = domParser.parseFromString(inputString, 'text/xml')\n//         .getElementsByTagName('svg')[0];\n//     return svgDOM.innerHTML\n// }\nfunction _setSVG(){_setSVG=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(frameToSet){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:console.log('setSVG');return _context4.abrupt(\"return\",new Promise(function(resolve,reject){try{(function(){// console.log('narcissus', flower.length)\nvar obj=\"\";// obj = obj + getSVGContents(flower[index])\n// obj = flower[index]\nvar _loop=function _loop(x){setTimeout(function(){// obj = obj + getSVGContents(flower[index])\nobj=flower[x];setNarcissus(obj);setScore(x);// console.log(index)\n},x*100);};// obj = obj + getSVGContents(flower[index])\n// obj = flower[index]\nfor(var x=0;x<frameToSet;x++){_loop(x);}console.log('about to set narcissus',obj);console.log('about to set narcissus',typeof obj);// setLoading(false);\n// setLoading(false);\nresolve(obj);})();}catch(err){console.log(\"err\",err);reject(err);}}));case 2:case\"end\":return _context4.stop();}}},_callee4);}));return _setSVG.apply(this,arguments);}useEffect(function(){init();},[]);return/*#__PURE__*/_jsx(\"div\",{className:\"App\",children:/*#__PURE__*/_jsxs(React.Fragment,{children:[/*#__PURE__*/_jsx(\"header\",{}),/*#__PURE__*/_jsx(\"main\",{ref:mainRef})]})});}export default App;// need to fetch the attention logs from koi state\n// then, iterate over the logs and sum the total attention\n// then, check the last time the nft was updated\n// then, check the nft's decay from it's state.decay\n// then, increment counters based on the difference of current block height and the block height at last adjustment\n// then, adjust the 'durability' score","map":{"version":3,"sources":["/home/al/Desktop/koi/narcissus/content/src/App.js"],"names":["React","useState","useEffect","useLayoutEffect","useRef","axios","media","state","id","totalFrames","App","narcissus","setNarcissus","loading","setLoading","score","setScore","mainRef","flower","updateScore","console","log","current","scoreSpan","document","createElement","innerText","className","appendChild","updateImage","blob","Blob","type","url","URL","createObjectURL","image","src","spans","getElementsByClassName","span","remove","narci","n","init","getCorrectFreezeFrame","correctFreezeFrame","setSVG","getData","get","response","data","error","oid","window","location","pathname","split","nft_state","koii_state","decay","lockState","lockBlock","lastLock","list","stateUpdate","trafficLogs","rewardReport","change","max","lastMax","scalar","last","i","item","dailyTrafficBlock","logsSummary","Object","keys","includes","aScore","newScore","remainder","frameToSet","Promise","resolve","reject","obj","x","setTimeout","err"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useLayoutEffect, useRef } from \"react\";\n\n// import * as kweb from \"@_koi/sdk/web\";\n// import gifFrames from \"gif-frames\";\nimport axios from 'axios';\nimport media from \"./narcissus.json\";\n\n// import SmartWeave from \"smartweave\";\n\nimport \"./App.css\";\n\n// console.log('narcissus', media, media.length)\n// const ktools = new kweb.Web();\n\n// console.log(\"ktools\", ktools);\n\nlet state;\nlet id;\n// let koii;\nlet totalFrames = 225;\n\nfunction App() {\n  const [narcissus, setNarcissus] = useState(<canvas></canvas>);\n  const [loading, setLoading] = useState(true);\n  const [score, setScore] = useState(0);\n  // const [canvas, setCanvas] = useState(<canvas></canvas>);\n  const mainRef = useRef(null)\n  const flower = media;\n\n  const updateScore = () => {\n    console.log(\"useEffect score\", mainRef, 'score is', score);\n    if (!mainRef.current) {\n      console.log('not updating score because', mainRef.current)\n      // setTimeout(updateScore, 1000)\n      return;\n    } else {\n      let scoreSpan = document.createElement('span')\n          scoreSpan.innerText = score;\n          scoreSpan.className = \"scoreSpan\"\n        \n      mainRef.current.appendChild(scoreSpan);\n    }\n  }\n\n  function updateImage () {\n    console.log(\"update narcissus\", mainRef);\n    if (!mainRef.current) {\n      \n      console.log('not updating narcissus because', mainRef.current)\n      \n      return;\n    } else {\n      console.log('about to append because main is', mainRef.current)\n\n      let blob = new Blob([narcissus], {type: 'image/svg+xml'});\n\n      let url = URL.createObjectURL(blob);\n\n      console.log('got url', url)\n      let image = document.createElement('img');\n\n      // image.addEventListener('onload', () => URL.revokeObjectURL(url), {once: true});\n          image.src = url;\n          image.className = \"narcissus\";\n\n      console.log('image', image)\n\n      mainRef.current.appendChild(image);\n    }\n  }\n\n  useLayoutEffect(() => {\n    console.log('triggered score update')\n    updateScore();\n\n    // Clean up\n    return () => {\n      var spans = document.getElementsByClassName('scoreSpan')\n      for ( let span of spans ) {\n        span.remove()\n      }\n    };\n  }, [score]);\n\n  \n  useLayoutEffect(() => {\n    console.log('triggered image update')\n    updateImage();\n\n    // Clean up\n    return () => {\n      // console.log(\"clean up\");\n      // // mainRef.current.innerHTML = null\n      let narci = document.getElementsByClassName('narcissus')\n      for ( let n of narci ) {\n        n.remove()\n      }\n\n    };\n  }, [narcissus]);\n\n  /* -- Functions -- */\n\n  const init = async () => {\n    let correctFreezeFrame = await getCorrectFreezeFrame()\n    console.log('setting frame', correctFreezeFrame)\n    await setSVG(correctFreezeFrame)\n    return { state, id };\n  };\n\n  async function getData (url) {\n    try {\n      const response = await axios.get(url);\n      console.log(response);\n      return response.data;\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  async function getCorrectFreezeFrame() {\n    try {\n      var oid = (window.location.pathname).split('/')[1] || '1ZjIecqKGYdGTFMWR9kdGrmi77lMmZnA6dxEzWulyjo';\n      // console.log('got oid', oid)\n      // var nft_state = await ktools.readNftState(oid);\n      var nft_state = await getData('https://arweave.net/1ZjIecqKGYdGTFMWR9kdGrmi77lMmZnA6dxEzWulyjo')\n      \n      // var koii_state = await ktools.getContractState();\n      var koii_state = await getData('https://arweave.net/cETTyJQYxJLVQ6nC3VxzsZf1x2-6TW2LFkGZa91gUWc');\n\n      // contract state\n      let current = nft_state.decay.lockState || 0;\n      let lockBlock = nft_state.decay.lastLock;\n      let list = koii_state.stateUpdate.trafficLogs.rewardReport;\n      let newScore; // this will contain the output\n\n      // looping variables\n      let change = 0;\n      let max = nft_state.decay.lastMax || 1;\n      let scalar = 1;\n      let last = 0;\n      let lastMax = 0;\n      let i = 0;\n\n      for ( var item of list ) {\n        // console.log('checking', i, 'change is ', change)\n        if ( item.dailyTrafficBlock > lockBlock ) { \n            if ( typeof(item.logsSummary) && Object.keys(item.logsSummary).includes(oid) ) {\n              let aScore = item.logsSummary[oid];\n              if ( aScore < max ) {\n                \n                if ( last === i - 1 ) {\n                  // if we are on a streak, incremement the scalar\n                  scalar = scalar + scalar;\n                }\n                \n                if ( ( i - 10 ) < lastMax ) {\n                  // we are in a recovery slump, so the scalar is negative now\n                  scalar = ( -1 ) * scalar;\n                }\n                \n                // increment the adjustment \n                change = change + aScore * ( 1 + scalar / 100 )\n\n              } else {\n                // if we have a new max we get a major boost\n                max = aScore;\n                lastMax = i;\n                change = change + 10000;\n              }\n              last = i;\n            }\n        }\n        i = i + 1;\n      }\n      \n      if (change < 1) {\n        // return current;\n        console.log('returning current', current)\n        newScore = current;\n        // return 200;\n      } else {\n        // return current + change;\n        let remainder = totalFrames - current; // the maximum score adjustment we can give (total frames less current score)\n        newScore = remainder * ( 10001 - change );\n        if ( newScore > totalFrames ) {\n          newScore = totalFrames;\n        } else if ( newScore < 0 ) {\n          newScore = 0;\n        }\n      }\n      // newScore = 200; // enable to check gif scrolling locally\n      console.log('newScore is', newScore)\n      // setScore(newScore);\n      return newScore;\n      // return 226;\n    } catch (err) {\n      console.log('error loading nft data', err)\n      setScore(1)\n      return 1;\n    }\n  }\n\n  async function setSVG(frameToSet) {\n    console.log('setSVG')\n    return new Promise(function (resolve, reject) {\n      try {\n        // console.log('narcissus', flower.length)\n        let obj = \"\";\n        // obj = obj + getSVGContents(flower[index])\n        // obj = flower[index]\n        for (let x = 0; x < frameToSet; x++ ) {\n          setTimeout( function () {\n            // obj = obj + getSVGContents(flower[index])\n            obj = flower[x]\n            setNarcissus(obj);\n            setScore(x)\n            // console.log(index)\n          }, x*100)\n        }\n        console.log('about to set narcissus', obj)\n        console.log('about to set narcissus', typeof(obj))\n        // setLoading(false);\n        resolve(obj);\n      } catch (err) {\n        console.log(\"err\", err);\n        reject(err);\n      }\n    });\n  }\n\n  // function getSVGContents(inputString){\n  //     let domParser = new DOMParser();\n  //     let svgDOM = domParser.parseFromString(inputString, 'text/xml')\n  //         .getElementsByTagName('svg')[0];\n  //     return svgDOM.innerHTML\n  // }\n\n  useEffect(() => {\n    init();\n  }, [])\n  \n  return (\n    <div className=\"App\">\n      {/* {loading && (\n        // <img alt=\"this is the loading icon\" src={window.location.origin + \"/img/narcissus.gif\"} />\n      )} */}\n      {/* {!loading && ( */}\n        <React.Fragment>\n          <header></header>\n          <main ref={mainRef}>\n          </main>\n        </React.Fragment>\n      {/* )} */}\n    </div>\n  );\n\n}\n\nexport default App;\n\n// need to fetch the attention logs from koi state\n// then, iterate over the logs and sum the total attention\n// then, check the last time the nft was updated\n// then, check the nft's decay from it's state.decay\n// then, increment counters based on the difference of current block height and the block height at last adjustment\n// then, adjust the 'durability' score\n"]},"metadata":{},"sourceType":"module"}