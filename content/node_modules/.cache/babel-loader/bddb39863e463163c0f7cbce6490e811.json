{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _asyncToGenerator = require(\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nvar _classCallCheck = require(\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function get() {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) {\n    if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  }\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.SiloResource = void 0;\n\nvar ArweaveUtils = __importStar(require(\"./lib/utils\"));\n\nvar Silo = /*#__PURE__*/function () {\n  function Silo(api, crypto, transactions) {\n    _classCallCheck(this, Silo);\n\n    this.api = api;\n    this.crypto = crypto;\n    this.transactions = transactions;\n  }\n\n  _createClass(Silo, [{\n    key: \"get\",\n    value: function () {\n      var _get = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(siloURI) {\n        var resource, ids, transaction, encrypted;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                if (siloURI) {\n                  _context.next = 2;\n                  break;\n                }\n\n                throw new Error(\"No Silo URI specified\");\n\n              case 2:\n                _context.next = 4;\n                return this.parseUri(siloURI);\n\n              case 4:\n                resource = _context.sent;\n                _context.next = 7;\n                return this.transactions.search(\"Silo-Name\", resource.getAccessKey());\n\n              case 7:\n                ids = _context.sent;\n\n                if (!(ids.length == 0)) {\n                  _context.next = 10;\n                  break;\n                }\n\n                throw new Error(\"No data could be found for the Silo URI: \".concat(siloURI));\n\n              case 10:\n                _context.next = 12;\n                return this.transactions.get(ids[0]);\n\n              case 12:\n                transaction = _context.sent;\n\n                if (transaction) {\n                  _context.next = 15;\n                  break;\n                }\n\n                throw new Error(\"No data could be found for the Silo URI: \".concat(siloURI));\n\n              case 15:\n                encrypted = transaction.get(\"data\", {\n                  decode: true,\n                  string: false\n                });\n                return _context.abrupt(\"return\", this.crypto.decrypt(encrypted, resource.getEncryptionKey()));\n\n              case 17:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function get(_x) {\n        return _get.apply(this, arguments);\n      }\n\n      return get;\n    }()\n  }, {\n    key: \"readTransactionData\",\n    value: function () {\n      var _readTransactionData = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(transaction, siloURI) {\n        var resource, encrypted;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                if (siloURI) {\n                  _context2.next = 2;\n                  break;\n                }\n\n                throw new Error(\"No Silo URI specified\");\n\n              case 2:\n                _context2.next = 4;\n                return this.parseUri(siloURI);\n\n              case 4:\n                resource = _context2.sent;\n                encrypted = transaction.get(\"data\", {\n                  decode: true,\n                  string: false\n                });\n                return _context2.abrupt(\"return\", this.crypto.decrypt(encrypted, resource.getEncryptionKey()));\n\n              case 7:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function readTransactionData(_x2, _x3) {\n        return _readTransactionData.apply(this, arguments);\n      }\n\n      return readTransactionData;\n    }()\n  }, {\n    key: \"parseUri\",\n    value: function () {\n      var _parseUri = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(siloURI) {\n        var parsed, siloName, hashIterations, digest, accessKey, encryptionkey;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                parsed = siloURI.match(/^([a-z0-9-_]+)\\.([0-9]+)/i);\n\n                if (parsed) {\n                  _context3.next = 3;\n                  break;\n                }\n\n                throw new Error(\"Invalid Silo name, must be a name in the format of [a-z0-9]+.[0-9]+, e.g. 'bubble.7'\");\n\n              case 3:\n                siloName = parsed[1];\n                hashIterations = Math.pow(2, parseInt(parsed[2]));\n                _context3.next = 7;\n                return this.hash(ArweaveUtils.stringToBuffer(siloName), hashIterations);\n\n              case 7:\n                digest = _context3.sent;\n                accessKey = ArweaveUtils.bufferTob64(digest.slice(0, 15));\n                _context3.next = 11;\n                return this.hash(digest.slice(16, 31), 1);\n\n              case 11:\n                encryptionkey = _context3.sent;\n                return _context3.abrupt(\"return\", new SiloResource(siloURI, accessKey, encryptionkey));\n\n              case 13:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function parseUri(_x4) {\n        return _parseUri.apply(this, arguments);\n      }\n\n      return parseUri;\n    }()\n  }, {\n    key: \"hash\",\n    value: function () {\n      var _hash = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(input, iterations) {\n        var digest, count;\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                _context4.next = 2;\n                return this.crypto.hash(input);\n\n              case 2:\n                digest = _context4.sent;\n                count = 0;\n\n              case 4:\n                if (!(count < iterations - 1)) {\n                  _context4.next = 11;\n                  break;\n                }\n\n                _context4.next = 7;\n                return this.crypto.hash(digest);\n\n              case 7:\n                digest = _context4.sent;\n\n              case 8:\n                count++;\n                _context4.next = 4;\n                break;\n\n              case 11:\n                return _context4.abrupt(\"return\", digest);\n\n              case 12:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this);\n      }));\n\n      function hash(_x5, _x6) {\n        return _hash.apply(this, arguments);\n      }\n\n      return hash;\n    }()\n  }]);\n\n  return Silo;\n}();\n\nexports.default = Silo;\n\nvar SiloResource = /*#__PURE__*/function () {\n  function SiloResource(uri, accessKey, encryptionKey) {\n    _classCallCheck(this, SiloResource);\n\n    this.uri = uri;\n    this.accessKey = accessKey;\n    this.encryptionKey = encryptionKey;\n  }\n\n  _createClass(SiloResource, [{\n    key: \"getUri\",\n    value: function getUri() {\n      return this.uri;\n    }\n  }, {\n    key: \"getAccessKey\",\n    value: function getAccessKey() {\n      return this.accessKey;\n    }\n  }, {\n    key: \"getEncryptionKey\",\n    value: function getEncryptionKey() {\n      return this.encryptionKey;\n    }\n  }]);\n\n  return SiloResource;\n}();\n\nexports.SiloResource = SiloResource;","map":{"version":3,"sources":["../../../src/common/silo.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.SiloResource = void 0;\nconst ArweaveUtils = __importStar(require(\"./lib/utils\"));\nclass Silo {\n    constructor(api, crypto, transactions) {\n        this.api = api;\n        this.crypto = crypto;\n        this.transactions = transactions;\n    }\n    async get(siloURI) {\n        if (!siloURI) {\n            throw new Error(`No Silo URI specified`);\n        }\n        const resource = await this.parseUri(siloURI);\n        const ids = await this.transactions.search(\"Silo-Name\", resource.getAccessKey());\n        if (ids.length == 0) {\n            throw new Error(`No data could be found for the Silo URI: ${siloURI}`);\n        }\n        const transaction = await this.transactions.get(ids[0]);\n        if (!transaction) {\n            throw new Error(`No data could be found for the Silo URI: ${siloURI}`);\n        }\n        const encrypted = transaction.get(\"data\", { decode: true, string: false });\n        return this.crypto.decrypt(encrypted, resource.getEncryptionKey());\n    }\n    async readTransactionData(transaction, siloURI) {\n        if (!siloURI) {\n            throw new Error(`No Silo URI specified`);\n        }\n        const resource = await this.parseUri(siloURI);\n        const encrypted = transaction.get(\"data\", { decode: true, string: false });\n        return this.crypto.decrypt(encrypted, resource.getEncryptionKey());\n    }\n    async parseUri(siloURI) {\n        const parsed = siloURI.match(/^([a-z0-9-_]+)\\.([0-9]+)/i);\n        if (!parsed) {\n            throw new Error(`Invalid Silo name, must be a name in the format of [a-z0-9]+.[0-9]+, e.g. 'bubble.7'`);\n        }\n        const siloName = parsed[1];\n        const hashIterations = Math.pow(2, parseInt(parsed[2]));\n        const digest = await this.hash(ArweaveUtils.stringToBuffer(siloName), hashIterations);\n        const accessKey = ArweaveUtils.bufferTob64(digest.slice(0, 15));\n        const encryptionkey = await this.hash(digest.slice(16, 31), 1);\n        return new SiloResource(siloURI, accessKey, encryptionkey);\n    }\n    async hash(input, iterations) {\n        let digest = await this.crypto.hash(input);\n        for (let count = 0; count < iterations - 1; count++) {\n            digest = await this.crypto.hash(digest);\n        }\n        return digest;\n    }\n}\nexports.default = Silo;\nclass SiloResource {\n    constructor(uri, accessKey, encryptionKey) {\n        this.uri = uri;\n        this.accessKey = accessKey;\n        this.encryptionKey = encryptionKey;\n    }\n    getUri() {\n        return this.uri;\n    }\n    getAccessKey() {\n        return this.accessKey;\n    }\n    getEncryptionKey() {\n        return this.encryptionKey;\n    }\n}\nexports.SiloResource = SiloResource;\n//# sourceMappingURL=silo.js.map"]},"metadata":{},"sourceType":"script"}