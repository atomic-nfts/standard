{"ast":null,"code":"'use strict';\n\nvar ContentStream = require('contentstream');\n\nvar GifEncoder = require('gif-encoder');\n\nvar jpegJs = require('jpeg-js');\n\nvar PNG = require('pngjs-nozlib').PNG;\n\nvar ndarray = require('ndarray');\n\nvar ops = require('ndarray-ops');\n\nvar through = require('through');\n\nfunction handleData(array, data, frame) {\n  var i,\n      j,\n      ptr = 0,\n      c;\n\n  if (array.shape.length === 4) {\n    return handleData(array.pick(frame), data, 0);\n  } else if (array.shape.length === 3) {\n    if (array.shape[2] === 3) {\n      ops.assign(ndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]), array);\n      ops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n    } else if (array.shape[2] === 4) {\n      ops.assign(ndarray(data, [array.shape[0], array.shape[1], 4], [4, array.shape[0] * 4, 1]), array);\n    } else if (array.shape[2] === 1) {\n      ops.assign(ndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]), ndarray(array.data, [array.shape[0], array.shape[1], 3], [array.stride[0], array.stride[1], 0], array.offset));\n      ops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n    } else {\n      return new Error('Incompatible array shape');\n    }\n  } else if (array.shape.length === 2) {\n    ops.assign(ndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]), ndarray(array.data, [array.shape[0], array.shape[1], 3], [array.stride[0], array.stride[1], 0], array.offset));\n    ops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n  } else {\n    return new Error('Incompatible array shape');\n  }\n\n  return data;\n}\n\nfunction haderror(err) {\n  var result = through();\n  result.emit('error', err);\n  return result;\n}\n\nmodule.exports = function savePixels(array, type, options) {\n  options = options || {};\n\n  switch (type.toUpperCase()) {\n    case 'JPG':\n    case '.JPG':\n    case 'JPEG':\n    case '.JPEG':\n    case 'JPE':\n    case '.JPE':\n      var width = array.shape[0];\n      var height = array.shape[1];\n      var data = new Buffer(width * height * 4);\n      data = handleData(array, data);\n      var rawImageData = {\n        data: data,\n        width: width,\n        height: height\n      };\n      var jpegImageData = jpegJs.encode(rawImageData, options.quality);\n      return new ContentStream(jpegImageData.data);\n\n    case 'GIF':\n    case '.GIF':\n      var frames = array.shape.length === 4 ? array.shape[0] : 1;\n      var width = array.shape.length === 4 ? array.shape[1] : array.shape[0];\n      var height = array.shape.length === 4 ? array.shape[2] : array.shape[1];\n      var data = new Buffer(width * height * 4);\n      var gif = new GifEncoder(width, height);\n      gif.writeHeader();\n\n      for (var i = 0; i < frames; i++) {\n        data = handleData(array, data, i);\n        gif.addFrame(data);\n      }\n\n      gif.finish();\n      return gif;\n\n    case 'PNG':\n    case '.PNG':\n      var png = new PNG({\n        width: array.shape[0],\n        height: array.shape[1]\n      });\n      var data = handleData(array, png.data);\n      if (typeof data === 'Error') return haderror(data);\n      png.data = data;\n      return png.pack();\n\n    case 'CANVAS':\n      var canvas = document.createElement('canvas');\n      var context = canvas.getContext('2d');\n      canvas.width = array.shape[0];\n      canvas.height = array.shape[1];\n      var imageData = context.getImageData(0, 0, canvas.width, canvas.height);\n      var data = imageData.data;\n      data = handleData(array, data);\n      if (typeof data === 'Error') return haderror(data);\n      context.putImageData(imageData, 0, 0);\n      return canvas;\n\n    default:\n      return haderror(new Error('Unsupported file type: ' + type));\n  }\n};","map":{"version":3,"sources":["/home/al/Desktop/koi/narcissus/content/node_modules/save-pixels-jpeg-js-upgrade/save-pixels.js"],"names":["ContentStream","require","GifEncoder","jpegJs","PNG","ndarray","ops","through","handleData","array","data","frame","i","j","ptr","c","shape","length","pick","assign","assigns","stride","offset","Error","haderror","err","result","emit","module","exports","savePixels","type","options","toUpperCase","width","height","Buffer","rawImageData","jpegImageData","encode","quality","frames","gif","writeHeader","addFrame","finish","png","pack","canvas","document","createElement","context","getContext","imageData","getImageData","putImageData"],"mappings":"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","sourcesContent":["'use strict'\n\nvar ContentStream = require('contentstream')\nvar GifEncoder = require('gif-encoder')\nvar jpegJs = require('jpeg-js')\nvar PNG = require('pngjs-nozlib').PNG\nvar ndarray = require('ndarray')\nvar ops = require('ndarray-ops')\nvar through = require('through')\n\nfunction handleData (array, data, frame) {\n  var i, j, ptr = 0, c\n  if (array.shape.length === 4) {\n    return handleData(array.pick(frame), data, 0)\n  } else if (array.shape.length === 3) {\n    if (array.shape[2] === 3) {\n      ops.assign(\n        ndarray(data,\n          [array.shape[0], array.shape[1], 3],\n          [4, 4 * array.shape[0], 1]),\n        array)\n      ops.assigns(\n        ndarray(data,\n          [array.shape[0] * array.shape[1]],\n          [4],\n          3),\n        255)\n    } else if (array.shape[2] === 4) {\n      ops.assign(\n        ndarray(data,\n          [array.shape[0], array.shape[1], 4],\n          [4, array.shape[0] * 4, 1]),\n        array)\n    } else if (array.shape[2] === 1) {\n      ops.assign(\n        ndarray(data,\n          [array.shape[0], array.shape[1], 3],\n          [4, 4 * array.shape[0], 1]),\n        ndarray(array.data,\n          [array.shape[0], array.shape[1], 3],\n          [array.stride[0], array.stride[1], 0],\n          array.offset))\n      ops.assigns(\n        ndarray(data,\n          [array.shape[0] * array.shape[1]],\n          [4],\n          3),\n        255)\n    } else {\n      return new Error('Incompatible array shape')\n    }\n  } else if (array.shape.length === 2) {\n    ops.assign(\n      ndarray(data,\n        [array.shape[0], array.shape[1], 3],\n        [4, 4 * array.shape[0], 1]),\n      ndarray(array.data,\n        [array.shape[0], array.shape[1], 3],\n        [array.stride[0], array.stride[1], 0],\n        array.offset))\n    ops.assigns(\n      ndarray(data,\n        [array.shape[0] * array.shape[1]],\n        [4],\n        3),\n      255)\n  } else {\n    return new Error('Incompatible array shape')\n  }\n  return data\n}\n\nfunction haderror (err) {\n  var result = through()\n  result.emit('error', err)\n  return result\n}\n\nmodule.exports = function savePixels (array, type, options) {\n  options = options || {}\n  switch (type.toUpperCase()) {\n    case 'JPG':\n    case '.JPG':\n    case 'JPEG':\n    case '.JPEG':\n    case 'JPE':\n    case '.JPE':\n      var width = array.shape[0]\n      var height = array.shape[1]\n      var data = new Buffer(width * height * 4)\n      data = handleData(array, data)\n      var rawImageData = {\n        data: data,\n        width: width,\n        height: height\n      }\n      var jpegImageData = jpegJs.encode(rawImageData, options.quality)\n      return new ContentStream(jpegImageData.data)\n\n    case 'GIF':\n    case '.GIF':\n      var frames = array.shape.length === 4 ? array.shape[0] : 1\n      var width = array.shape.length === 4 ? array.shape[1] : array.shape[0]\n      var height = array.shape.length === 4 ? array.shape[2] : array.shape[1]\n      var data = new Buffer(width * height * 4)\n      var gif = new GifEncoder(width, height)\n      gif.writeHeader()\n      for (var i = 0; i < frames; i++) {\n        data = handleData(array, data, i)\n        gif.addFrame(data)\n      }\n      gif.finish()\n      return gif\n\n    case 'PNG':\n    case '.PNG':\n      var png = new PNG({\n        width: array.shape[0],\n        height: array.shape[1]\n      })\n      var data = handleData(array, png.data)\n      if (typeof data === 'Error') return haderror(data)\n      png.data = data\n      return png.pack()\n\n    case 'CANVAS':\n      var canvas = document.createElement('canvas')\n      var context = canvas.getContext('2d')\n      canvas.width = array.shape[0]\n      canvas.height = array.shape[1]\n      var imageData = context.getImageData(0, 0, canvas.width, canvas.height)\n      var data = imageData.data\n      data = handleData(array, data)\n      if (typeof data === 'Error') return haderror(data)\n      context.putImageData(imageData, 0, 0)\n      return canvas\n\n    default:\n      return haderror(new Error('Unsupported file type: ' + type))\n  }\n}\n"]},"metadata":{},"sourceType":"script"}