{"ast":null,"code":"\"use strict\";\n\nvar _toConsumableArray = require(\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/toConsumableArray\");\n\nvar _regeneratorRuntime = require(\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _createForOfIteratorHelper = require(\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createForOfIteratorHelper\");\n\nvar _slicedToArray = require(\"/home/al/Desktop/koi/narcissus/content/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/slicedToArray\");\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.readContract = void 0;\n\nvar contract_load_1 = require(\"./contract-load\");\n\nvar utils_1 = require(\"./utils\");\n\nvar contract_step_1 = require(\"./contract-step\");\n\nvar errors_1 = __importDefault(require(\"./errors\"));\n/**\n * Queries all interaction transactions and replays a contract to its latest state.\n *\n * If height is provided, will replay only to that block height.\n *\n * @param arweave         an Arweave client instance\n * @param contractId      the Transaction Id of the contract\n * @param height          if specified the contract will be replayed only to this block height\n * @param returnValidity  if true, the function will return valid and invalid transaction IDs along with the state\n */\n\n\nfunction readContract(arweave, contractId, height, returnValidity) {\n  return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n    var networkInfo, loadPromise, fetchTxPromise, _yield$Promise$all, _yield$Promise$all2, contractInfo, txInfos, state, contractSrc, _contractInfo, handler, swGlobal, validity, _iterator, _step, txInfo, currentTx, contractIndex, inputTag, input, interaction, result, settings, evolve, canEvolve, error;\n\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            if (height) {\n              _context.next = 5;\n              break;\n            }\n\n            _context.next = 3;\n            return arweave.network.getInfo();\n\n          case 3:\n            networkInfo = _context.sent;\n            height = networkInfo.height;\n\n          case 5:\n            loadPromise = contract_load_1.loadContract(arweave, contractId).catch(function (err) {\n              var error = new errors_1.default(\"CONTRACT_NOT_FOUND\"\n              /* CONTRACT_NOT_FOUND */\n              , {\n                message: \"Contract having txId: \".concat(contractId, \" not found\"),\n                requestedTxId: contractId\n              });\n              throw error;\n            });\n            fetchTxPromise = fetchTransactions(arweave, contractId, height).catch(function (err) {\n              return err;\n            }); // tslint:disable-next-line: prefer-const\n\n            _context.next = 9;\n            return Promise.all([loadPromise, fetchTxPromise]);\n\n          case 9:\n            _yield$Promise$all = _context.sent;\n            _yield$Promise$all2 = _slicedToArray(_yield$Promise$all, 2);\n            contractInfo = _yield$Promise$all2[0];\n            txInfos = _yield$Promise$all2[1];\n\n            if (!(contractInfo instanceof Error)) {\n              _context.next = 15;\n              break;\n            }\n\n            throw contractInfo;\n\n          case 15:\n            if (!(txInfos instanceof Error)) {\n              _context.next = 17;\n              break;\n            }\n\n            throw txInfos;\n\n          case 17:\n            contractSrc = contractInfo.contractSrc;\n            _context.prev = 18;\n            state = JSON.parse(contractInfo.initState);\n            _context.next = 25;\n            break;\n\n          case 22:\n            _context.prev = 22;\n            _context.t0 = _context[\"catch\"](18);\n            throw new Error(\"Unable to parse initial state for contract: \".concat(contractId));\n\n          case 25:\n            utils_1.log(arweave, \"Replaying \".concat(txInfos.length, \" confirmed interactions\"));\n            _context.next = 28;\n            return sortTransactions(arweave, txInfos);\n\n          case 28:\n            // tslint:disable-next-line: prefer-const\n            _contractInfo = contractInfo, handler = _contractInfo.handler, swGlobal = _contractInfo.swGlobal;\n            validity = {};\n            _iterator = _createForOfIteratorHelper(txInfos);\n            _context.prev = 31;\n\n            _iterator.s();\n\n          case 33:\n            if ((_step = _iterator.n()).done) {\n              _context.next = 81;\n              break;\n            }\n\n            txInfo = _step.value;\n            currentTx = txInfo.node;\n            contractIndex = txInfo.node.tags.findIndex(function (tag) {\n              return tag.name === 'Contract' && tag.value === contractId;\n            });\n            inputTag = txInfo.node.tags[contractIndex + 1];\n\n            if (!(!inputTag || inputTag.name !== 'Input')) {\n              _context.next = 41;\n              break;\n            }\n\n            utils_1.log(arweave, \"Skipping tx with missing or invalid Input tag - \".concat(currentTx.id));\n            return _context.abrupt(\"continue\", 79);\n\n          case 41:\n            input = inputTag.value;\n            _context.prev = 42;\n            input = JSON.parse(input);\n            _context.next = 50;\n            break;\n\n          case 46:\n            _context.prev = 46;\n            _context.t1 = _context[\"catch\"](42);\n            utils_1.log(arweave, _context.t1);\n            return _context.abrupt(\"continue\", 79);\n\n          case 50:\n            if (input) {\n              _context.next = 53;\n              break;\n            }\n\n            utils_1.log(arweave, \"Skipping tx with missing or invalid Input tag - \".concat(currentTx.id));\n            return _context.abrupt(\"continue\", 79);\n\n          case 53:\n            interaction = {\n              input: input,\n              caller: currentTx.owner.address\n            };\n            swGlobal._activeTx = currentTx;\n            _context.next = 57;\n            return contract_step_1.execute(handler, interaction, state);\n\n          case 57:\n            result = _context.sent;\n\n            if (result.type === 'exception') {\n              utils_1.log(arweave, \"\".concat(result.result));\n              utils_1.log(arweave, \"Executing of interaction: \".concat(currentTx.id, \" threw exception.\"));\n            }\n\n            if (result.type === 'error') {\n              utils_1.log(arweave, \"\".concat(result.result));\n              utils_1.log(arweave, \"Executing of interaction: \".concat(currentTx.id, \" returned error.\"));\n            }\n\n            validity[currentTx.id] = result.type === 'ok';\n            state = result.state;\n            settings = state.settings ? new Map(state.settings) : new Map();\n            evolve = state.evolve || settings.get('evolve');\n            canEvolve = state.canEvolve || settings.get('canEvolve'); // By default, contracts can evolve if there's not an explicit `false`.\n\n            if (canEvolve === undefined || canEvolve === null) {\n              canEvolve = true;\n            }\n\n            if (!(evolve && /[a-z0-9_-]{43}/i.test(evolve) && canEvolve)) {\n              _context.next = 79;\n              break;\n            }\n\n            if (!(contractSrc !== state.evolve)) {\n              _context.next = 79;\n              break;\n            }\n\n            _context.prev = 68;\n            _context.next = 71;\n            return contract_load_1.loadContract(arweave, contractId, evolve);\n\n          case 71:\n            contractInfo = _context.sent;\n            handler = contractInfo.handler;\n            _context.next = 79;\n            break;\n\n          case 75:\n            _context.prev = 75;\n            _context.t2 = _context[\"catch\"](68);\n            error = new errors_1.default(\"CONTRACT_NOT_FOUND\"\n            /* CONTRACT_NOT_FOUND */\n            , {\n              message: \"Contract having txId: \".concat(contractId, \" not found\"),\n              requestedTxId: contractId\n            });\n            throw error;\n\n          case 79:\n            _context.next = 33;\n            break;\n\n          case 81:\n            _context.next = 86;\n            break;\n\n          case 83:\n            _context.prev = 83;\n            _context.t3 = _context[\"catch\"](31);\n\n            _iterator.e(_context.t3);\n\n          case 86:\n            _context.prev = 86;\n\n            _iterator.f();\n\n            return _context.finish(86);\n\n          case 89:\n            return _context.abrupt(\"return\", returnValidity ? {\n              state: state,\n              validity: validity\n            } : state);\n\n          case 90:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, null, [[18, 22], [31, 83, 86, 89], [42, 46], [68, 75]]);\n  }));\n}\n\nexports.readContract = readContract; // Sort the transactions based on the sort key generated in addSortKey()\n\nfunction sortTransactions(arweave, txInfos) {\n  return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n    var addKeysFuncs;\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            addKeysFuncs = txInfos.map(function (tx) {\n              return addSortKey(arweave, tx);\n            });\n            _context2.next = 3;\n            return Promise.all(addKeysFuncs);\n\n          case 3:\n            txInfos.sort(function (a, b) {\n              return a.sortKey.localeCompare(b.sortKey);\n            });\n\n          case 4:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2);\n  }));\n} // Construct a string that will lexographically sort.\n// { block_height, sha256(block_indep_hash + txid) }\n// pad block height to 12 digits and convert hash value\n// to a hex string.\n\n\nfunction addSortKey(arweave, txInfo) {\n  return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n    var node, blockHashBytes, txIdBytes, concatted, hashed, blockHeight;\n    return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            node = txInfo.node;\n            blockHashBytes = arweave.utils.b64UrlToBuffer(node.block.id);\n            txIdBytes = arweave.utils.b64UrlToBuffer(node.id);\n            concatted = arweave.utils.concatBuffers([blockHashBytes, txIdBytes]);\n            _context3.t0 = utils_1;\n            _context3.next = 7;\n            return arweave.crypto.hash(concatted);\n\n          case 7:\n            _context3.t1 = _context3.sent;\n            hashed = _context3.t0.arrayToHex.call(_context3.t0, _context3.t1);\n            blockHeight = \"000000\".concat(node.block.height).slice(-12);\n            txInfo.sortKey = \"\".concat(blockHeight, \",\").concat(hashed);\n\n          case 11:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, _callee3);\n  }));\n} // the maximum number of transactions we can get from graphql at once\n\n\nvar MAX_REQUEST = 100; // fetch all contract interactions up to the specified block height\n\nfunction fetchTransactions(arweave, contractId, height) {\n  return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n    var variables, transactions, txInfos, cursor;\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            variables = {\n              tags: [{\n                name: 'App-Name',\n                values: ['SmartWeaveAction']\n              }, {\n                name: 'Contract',\n                values: [contractId]\n              }],\n              blockFilter: {\n                max: height\n              },\n              first: MAX_REQUEST\n            };\n            _context4.next = 3;\n            return getNextPage(arweave, variables);\n\n          case 3:\n            transactions = _context4.sent;\n            txInfos = transactions.edges.filter(function (tx) {\n              return !tx.node.parent || !tx.node.parent.id;\n            });\n\n          case 5:\n            if (!transactions.pageInfo.hasNextPage) {\n              _context4.next = 14;\n              break;\n            }\n\n            cursor = transactions.edges[MAX_REQUEST - 1].cursor;\n            variables = Object.assign(Object.assign({}, variables), {\n              after: cursor\n            });\n            _context4.next = 10;\n            return getNextPage(arweave, variables);\n\n          case 10:\n            transactions = _context4.sent;\n            txInfos.push.apply(txInfos, _toConsumableArray(transactions.edges.filter(function (tx) {\n              return !tx.node.parent || !tx.node.parent.id;\n            })));\n            _context4.next = 5;\n            break;\n\n          case 14:\n            return _context4.abrupt(\"return\", txInfos);\n\n          case 15:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  }));\n}\n\nfunction getNextPage(arweave, variables) {\n  return __awaiter(this, void 0, void 0, /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {\n    var query, response, data, txs;\n    return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n      while (1) {\n        switch (_context5.prev = _context5.next) {\n          case 0:\n            query = \"query Transactions($tags: [TagFilter!]!, $blockFilter: BlockFilter!, $first: Int!, $after: String) {\\n    transactions(tags: $tags, block: $blockFilter, first: $first, sort: HEIGHT_ASC, after: $after) {\\n      pageInfo {\\n        hasNextPage\\n      }\\n      edges {\\n        node {\\n          id\\n          owner { address }\\n          recipient\\n          tags {\\n            name\\n            value\\n          }\\n          block {\\n            height\\n            id\\n            timestamp\\n          }\\n          fee { winston }\\n          quantity { winston }\\n          parent { id }\\n        }\\n        cursor\\n      }\\n    }\\n  }\";\n            _context5.next = 3;\n            return arweave.api.post('graphql', {\n              query: query,\n              variables: variables\n            });\n\n          case 3:\n            response = _context5.sent;\n\n            if (!(response.status !== 200)) {\n              _context5.next = 6;\n              break;\n            }\n\n            throw new Error(\"Unable to retrieve transactions. Arweave gateway responded with status \".concat(response.status, \".\"));\n\n          case 6:\n            data = response.data;\n            txs = data.data.transactions;\n            return _context5.abrupt(\"return\", txs);\n\n          case 9:\n          case \"end\":\n            return _context5.stop();\n        }\n      }\n    }, _callee5);\n  }));\n}","map":{"version":3,"sources":["/home/al/Desktop/koi/narcissus/content/node_modules/smartweave/lib/contract-read.js"],"names":["__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","apply","__importDefault","mod","__esModule","Object","defineProperty","exports","readContract","contract_load_1","require","utils_1","contract_step_1","errors_1","arweave","contractId","height","returnValidity","network","getInfo","networkInfo","loadPromise","loadContract","catch","err","error","default","message","requestedTxId","fetchTxPromise","fetchTransactions","all","contractInfo","txInfos","Error","contractSrc","state","JSON","parse","initState","log","length","sortTransactions","handler","swGlobal","validity","txInfo","currentTx","node","contractIndex","tags","findIndex","tag","name","inputTag","id","input","interaction","caller","owner","address","_activeTx","execute","type","settings","Map","evolve","get","canEvolve","undefined","test","addKeysFuncs","map","tx","addSortKey","sort","a","b","sortKey","localeCompare","blockHashBytes","utils","b64UrlToBuffer","block","txIdBytes","concatted","concatBuffers","crypto","hash","hashed","arrayToHex","blockHeight","slice","MAX_REQUEST","variables","values","blockFilter","max","first","getNextPage","transactions","edges","filter","parent","pageInfo","hasNextPage","cursor","assign","after","push","query","api","post","response","status","data","txs"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.readContract = void 0;\nconst contract_load_1 = require(\"./contract-load\");\nconst utils_1 = require(\"./utils\");\nconst contract_step_1 = require(\"./contract-step\");\nconst errors_1 = __importDefault(require(\"./errors\"));\n/**\n * Queries all interaction transactions and replays a contract to its latest state.\n *\n * If height is provided, will replay only to that block height.\n *\n * @param arweave         an Arweave client instance\n * @param contractId      the Transaction Id of the contract\n * @param height          if specified the contract will be replayed only to this block height\n * @param returnValidity  if true, the function will return valid and invalid transaction IDs along with the state\n */\nfunction readContract(arweave, contractId, height, returnValidity) {\n    return __awaiter(this, void 0, void 0, function* () {\n        if (!height) {\n            const networkInfo = yield arweave.network.getInfo();\n            height = networkInfo.height;\n        }\n        const loadPromise = contract_load_1.loadContract(arweave, contractId).catch((err) => {\n            const error = new errors_1.default(\"CONTRACT_NOT_FOUND\" /* CONTRACT_NOT_FOUND */, {\n                message: `Contract having txId: ${contractId} not found`,\n                requestedTxId: contractId,\n            });\n            throw error;\n        });\n        const fetchTxPromise = fetchTransactions(arweave, contractId, height).catch((err) => err);\n        // tslint:disable-next-line: prefer-const\n        let [contractInfo, txInfos] = yield Promise.all([loadPromise, fetchTxPromise]);\n        if (contractInfo instanceof Error)\n            throw contractInfo;\n        if (txInfos instanceof Error)\n            throw txInfos;\n        let state;\n        const contractSrc = contractInfo.contractSrc;\n        try {\n            state = JSON.parse(contractInfo.initState);\n        }\n        catch (e) {\n            throw new Error(`Unable to parse initial state for contract: ${contractId}`);\n        }\n        utils_1.log(arweave, `Replaying ${txInfos.length} confirmed interactions`);\n        yield sortTransactions(arweave, txInfos);\n        // tslint:disable-next-line: prefer-const\n        let { handler, swGlobal } = contractInfo;\n        const validity = {};\n        for (const txInfo of txInfos) {\n            const currentTx = txInfo.node;\n            const contractIndex = txInfo.node.tags.findIndex((tag) => tag.name === 'Contract' && tag.value === contractId);\n            const inputTag = txInfo.node.tags[contractIndex + 1];\n            if (!inputTag || inputTag.name !== 'Input') {\n                utils_1.log(arweave, `Skipping tx with missing or invalid Input tag - ${currentTx.id}`);\n                continue;\n            }\n            let input = inputTag.value;\n            try {\n                input = JSON.parse(input);\n            }\n            catch (e) {\n                utils_1.log(arweave, e);\n                continue;\n            }\n            if (!input) {\n                utils_1.log(arweave, `Skipping tx with missing or invalid Input tag - ${currentTx.id}`);\n                continue;\n            }\n            const interaction = {\n                input,\n                caller: currentTx.owner.address,\n            };\n            swGlobal._activeTx = currentTx;\n            const result = yield contract_step_1.execute(handler, interaction, state);\n            if (result.type === 'exception') {\n                utils_1.log(arweave, `${result.result}`);\n                utils_1.log(arweave, `Executing of interaction: ${currentTx.id} threw exception.`);\n            }\n            if (result.type === 'error') {\n                utils_1.log(arweave, `${result.result}`);\n                utils_1.log(arweave, `Executing of interaction: ${currentTx.id} returned error.`);\n            }\n            validity[currentTx.id] = result.type === 'ok';\n            state = result.state;\n            const settings = state.settings ? new Map(state.settings) : new Map();\n            const evolve = state.evolve || settings.get('evolve');\n            let canEvolve = state.canEvolve || settings.get('canEvolve');\n            // By default, contracts can evolve if there's not an explicit `false`.\n            if (canEvolve === undefined || canEvolve === null) {\n                canEvolve = true;\n            }\n            if (evolve && /[a-z0-9_-]{43}/i.test(evolve) && canEvolve) {\n                if (contractSrc !== state.evolve) {\n                    try {\n                        contractInfo = yield contract_load_1.loadContract(arweave, contractId, evolve);\n                        handler = contractInfo.handler;\n                    }\n                    catch (e) {\n                        const error = new errors_1.default(\"CONTRACT_NOT_FOUND\" /* CONTRACT_NOT_FOUND */, {\n                            message: `Contract having txId: ${contractId} not found`,\n                            requestedTxId: contractId,\n                        });\n                        throw error;\n                    }\n                }\n            }\n        }\n        return returnValidity ? { state, validity } : state;\n    });\n}\nexports.readContract = readContract;\n// Sort the transactions based on the sort key generated in addSortKey()\nfunction sortTransactions(arweave, txInfos) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const addKeysFuncs = txInfos.map((tx) => addSortKey(arweave, tx));\n        yield Promise.all(addKeysFuncs);\n        txInfos.sort((a, b) => a.sortKey.localeCompare(b.sortKey));\n    });\n}\n// Construct a string that will lexographically sort.\n// { block_height, sha256(block_indep_hash + txid) }\n// pad block height to 12 digits and convert hash value\n// to a hex string.\nfunction addSortKey(arweave, txInfo) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const { node } = txInfo;\n        const blockHashBytes = arweave.utils.b64UrlToBuffer(node.block.id);\n        const txIdBytes = arweave.utils.b64UrlToBuffer(node.id);\n        const concatted = arweave.utils.concatBuffers([blockHashBytes, txIdBytes]);\n        const hashed = utils_1.arrayToHex(yield arweave.crypto.hash(concatted));\n        const blockHeight = `000000${node.block.height}`.slice(-12);\n        txInfo.sortKey = `${blockHeight},${hashed}`;\n    });\n}\n// the maximum number of transactions we can get from graphql at once\nconst MAX_REQUEST = 100;\n// fetch all contract interactions up to the specified block height\nfunction fetchTransactions(arweave, contractId, height) {\n    return __awaiter(this, void 0, void 0, function* () {\n        let variables = {\n            tags: [\n                {\n                    name: 'App-Name',\n                    values: ['SmartWeaveAction'],\n                },\n                {\n                    name: 'Contract',\n                    values: [contractId],\n                },\n            ],\n            blockFilter: {\n                max: height,\n            },\n            first: MAX_REQUEST,\n        };\n        let transactions = yield getNextPage(arweave, variables);\n        const txInfos = transactions.edges.filter((tx) => !tx.node.parent || !tx.node.parent.id);\n        while (transactions.pageInfo.hasNextPage) {\n            const cursor = transactions.edges[MAX_REQUEST - 1].cursor;\n            variables = Object.assign(Object.assign({}, variables), { after: cursor });\n            transactions = yield getNextPage(arweave, variables);\n            txInfos.push(...transactions.edges.filter((tx) => !tx.node.parent || !tx.node.parent.id));\n        }\n        return txInfos;\n    });\n}\nfunction getNextPage(arweave, variables) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const query = `query Transactions($tags: [TagFilter!]!, $blockFilter: BlockFilter!, $first: Int!, $after: String) {\n    transactions(tags: $tags, block: $blockFilter, first: $first, sort: HEIGHT_ASC, after: $after) {\n      pageInfo {\n        hasNextPage\n      }\n      edges {\n        node {\n          id\n          owner { address }\n          recipient\n          tags {\n            name\n            value\n          }\n          block {\n            height\n            id\n            timestamp\n          }\n          fee { winston }\n          quantity { winston }\n          parent { id }\n        }\n        cursor\n      }\n    }\n  }`;\n        const response = yield arweave.api.post('graphql', {\n            query,\n            variables,\n        });\n        if (response.status !== 200) {\n            throw new Error(`Unable to retrieve transactions. Arweave gateway responded with status ${response.status}.`);\n        }\n        const data = response.data;\n        const txs = data.data.transactions;\n        return txs;\n    });\n}\n"]},"metadata":{},"sourceType":"script"}